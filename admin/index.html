<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Newness of Life</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0a;
      --bg-elevated: #141414;
      --bg-hover: #1a1a1a;
      --bg-active: #252525;
      --border: #2a2a2a;
      --border-light: #333;
      --text: #fafafa;
      --text-secondary: #a0a0a0;
      --text-muted: #666;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --sidebar-width: 240px;
    }

    /* Light Mode */
    [data-theme="light"] {
      --bg: #f8fafc;
      --bg-elevated: #ffffff;
      --bg-hover: #f1f5f9;
      --bg-active: #e2e8f0;
      --border: #e2e8f0;
      --border-light: #cbd5e1;
      --text: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 14px;
      line-height: 1.5;
    }

    .app { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 100;
    }

    .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--text);
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .logo-text { font-weight: 600; font-size: 14px; }

    .sidebar-nav { flex: 1; padding: 12px 8px; overflow-y: auto; }
    .nav-section { margin-bottom: 20px; }
    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      padding: 8px 12px 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 2px;
    }

    .nav-item:hover { background: var(--bg-hover); color: var(--text); }
    .nav-item.active { background: var(--bg-active); color: var(--text); }
    .nav-item i { width: 18px; text-align: center; font-size: 15px; color: var(--primary); }
    .nav-item.active i { color: var(--primary); }
    .nav-item:hover i { color: var(--primary); }

    .nav-item-badge {
      margin-left: auto;
      background: var(--primary);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    .sidebar-footer { padding: 12px 16px; border-top: 1px solid var(--border); }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      margin-bottom: 8px;
    }
    .theme-toggle-label { font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
    .theme-toggle-label i { color: var(--warning); }
    .theme-toggle-btn {
      width: 44px;
      height: 24px;
      background: var(--bg-active);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
    }
    .theme-toggle-btn::after {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      background: var(--text);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: all 0.3s;
    }
    [data-theme="light"] .theme-toggle-btn { background: var(--primary); }
    [data-theme="light"] .theme-toggle-btn::after { transform: translateX(20px); background: white; }
    [data-theme="light"] .theme-toggle-label i { color: var(--primary); }

    .server-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
    }
    .status-dot.online { background: var(--success); }

    .main {
      flex: 1;
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      height: 56px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-title { font-size: 14px; font-weight: 600; }
    .header-subtitle { font-size: 12px; color: var(--text-muted); margin-left: 8px; }
    .header-actions { display: flex; align-items: center; gap: 8px; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
      text-decoration: none;
      white-space: nowrap;
    }

    .btn i { font-size: 12px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover:not(:disabled) { background: #16a34a; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-secondary { background: var(--bg-elevated); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover:not(:disabled) { background: var(--bg-hover); border-color: var(--border-light); }
    .btn-ghost { background: transparent; color: var(--text-secondary); padding: 8px; }
    .btn-ghost:hover { background: var(--bg-hover); color: var(--text); }
    .btn-sm { padding: 6px 10px; font-size: 12px; }

    .content { flex: 1; padding: 24px; }
    .view { display: none; }
    .view.active { display: block; }

    .card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title { font-size: 14px; font-weight: 600; }
    .card-body { padding: 20px; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
    }

    .stat-card h3 {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-card .value { font-size: 28px; font-weight: 700; color: var(--text); }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .quick-action {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .quick-action:hover { border-color: var(--primary); background: var(--bg-hover); }

    .quick-action-icon {
      width: 40px;
      height: 40px;
      background: var(--bg-active);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }

    .quick-action h4 { font-size: 13px; font-weight: 600; }
    .quick-action p { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    .page-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .page-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.15s;
    }

    .page-card:hover { border-color: var(--primary); transform: translateY(-2px); }

    .page-card-preview {
      height: 140px;
      background: var(--bg-active);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 32px;
    }

    .page-card-body { padding: 16px; }
    .page-card-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .page-card-desc { font-size: 12px; color: var(--text-muted); }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      transition: all 0.15s;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea { min-height: 100px; resize: vertical; }

    .form-section {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .form-section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-hover);
      cursor: pointer;
      user-select: none;
    }

    .form-section-header:hover { background: var(--bg-active); }
    .form-section-header i { color: var(--primary); font-size: 14px; width: 20px; text-align: center; }
    .form-section-header h3 { flex: 1; font-size: 13px; font-weight: 600; }
    .form-section-toggle { color: var(--text-muted); font-size: 12px; transition: transform 0.2s; }
    .form-section.collapsed .form-section-toggle { transform: rotate(-90deg); }
    .form-section.collapsed .form-section-body { display: none; }
    .form-section-body { padding: 16px; }

    .image-field { display: flex; gap: 12px; align-items: flex-start; }

    .image-preview {
      width: 120px;
      height: 80px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .image-preview img { width: 100%; height: 100%; object-fit: cover; }
    .image-preview-empty { color: var(--text-muted); font-size: 24px; }
    .image-actions { display: flex; flex-direction: column; gap: 6px; }

    .event-image-picker { display: flex; gap: 12px; align-items: flex-start; }
    .event-image-preview {
      width: 160px;
      height: 100px;
      background: var(--bg);
      border: 2px dashed var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      flex-shrink: 0;
      overflow: hidden;
    }
    .event-image-preview i { font-size: 24px; color: var(--text-muted); }
    .event-image-preview span { font-size: 11px; color: var(--text-muted); }
    .event-image-preview img { width: 100%; height: 100%; object-fit: cover; }
    .event-image-preview.has-image { border-style: solid; }
    .event-image-actions { display: flex; flex-direction: column; gap: 8px; }
    .flyer-style-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
    }
    .flyer-range-value {
      font-size: 12px;
      color: var(--text-muted);
      margin-left: 6px;
      font-weight: 500;
    }
    .flyer-style-grid input[type="range"] {
      width: 100%;
      accent-color: var(--primary);
    }
    .schedule-editor {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .schedule-empty {
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 10px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      background: var(--bg-elevated);
    }
    .schedule-row {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-elevated);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .schedule-row-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }
    .schedule-row-actions {
      display: flex;
      justify-content: flex-end;
    }

    .icon-picker {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .icon-option {
      width: 36px;
      height: 36px;
      border: 2px solid transparent;
      border-radius: 8px;
      background: var(--bg-elevated);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .icon-option:hover { background: var(--bg-hover); color: var(--text); }
    .icon-option.selected { border-color: var(--primary); background: var(--primary); color: white; }
    .icon-option i { font-size: 14px; }

    .color-picker-row { display: flex; align-items: center; gap: 10px; }
    .color-input {
      width: 40px;
      height: 36px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      padding: 0;
    }
    .color-input::-webkit-color-swatch-wrapper { padding: 2px; }
    .color-input::-webkit-color-swatch { border: none; border-radius: 4px; }
    .color-presets { display: flex; gap: 4px; }
    .color-preset {
      width: 24px;
      height: 24px;
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .color-preset:hover { transform: scale(1.15); }

    .toggle-wrapper { display: flex; align-items: center; gap: 10px; }

    .toggle { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-active);
      border-radius: 20px;
      transition: 0.2s;
    }

    .toggle-slider:before {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.2s;
    }

    .toggle input:checked + .toggle-slider { background: var(--primary); }
    .toggle input:checked + .toggle-slider:before { transform: translateX(16px); }
    .toggle-label { font-size: 13px; color: var(--text-secondary); }

    .editor-note {
      margin-bottom: 14px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-elevated);
      color: var(--text-secondary);
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .editor-note i { color: var(--primary); margin-right: 6px; }

    .editor-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .section-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }

    .event-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
    }
    .event-card:hover { border-color: var(--border-light); transform: translateY(-2px); }
    .event-card.unpublished { opacity: 0.6; }

    .event-card-image {
      height: 140px;
      background: linear-gradient(135deg, var(--bg-active), var(--bg-hover));
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .event-card-image img { width: 100%; height: 100%; object-fit: cover; }
    .event-card-image i { font-size: 32px; color: var(--text-muted); }

    .event-card-badges {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .event-card-body { padding: 16px; }

    .event-card-category {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 10px;
    }

    .event-card-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; line-height: 1.3; }

    .event-card-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }
    .event-card-info-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .event-card-info-item i { width: 16px; color: var(--text-muted); }

    .event-card-desc {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      line-clamp: 2;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 14px;
    }

    .event-card-actions {
      display: flex;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    .event-card-actions .btn { flex: 1; justify-content: center; }

    .header-subtitle { font-size: 13px; color: var(--text-muted); margin-left: 12px; }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-success { background: rgba(34, 197, 94, 0.1); color: var(--success); }
    .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .badge-info { background: rgba(59, 130, 246, 0.1); color: var(--primary); }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .media-item {
      aspect-ratio: 1;
      background: var(--bg-active);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }

    .media-item:hover { border-color: var(--primary); }
    .media-item.selected { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary); }
    .media-item img { width: 100%; height: 100%; object-fit: cover; }

    .media-item-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 2;
    }

    .media-item:hover .media-item-actions { opacity: 1; }

    .media-delete-btn {
      width: 28px;
      height: 28px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(17, 24, 39, 0.88);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.15s, background 0.15s;
    }

    .media-delete-btn:hover {
      background: var(--danger);
      transform: translateY(-1px);
    }

    .media-item-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 8px;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      font-size: 11px;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .media-item:hover .media-item-overlay { opacity: 1; }

    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 24px;
    }

    .upload-zone:hover { border-color: var(--primary); background: var(--bg-hover); }
    .upload-zone i { font-size: 32px; color: var(--text-muted); margin-bottom: 12px; }
    .upload-zone h3 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .upload-zone p { font-size: 12px; color: var(--text-muted); }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 85vh;
      overflow: hidden;
      transform: scale(0.95);
      transition: transform 0.2s;
    }

    .modal-overlay.active .modal { transform: scale(1); }
    .modal-lg { max-width: 700px; }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title { font-size: 14px; font-weight: 600; }
    .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      padding: 12px 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--danger); }
    .toast.info { border-left: 3px solid var(--primary); }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-muted);
      gap: 10px;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state h3 { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
    .empty-state p { font-size: 13px; margin-bottom: 20px; }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
    }

    .editor-layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 0;
      height: calc(100vh - 56px);
      margin: -24px;
    }

    .editor-preview {
      background: var(--bg-active);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .preview-header {
      padding: 12px 16px;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .preview-url {
      flex: 1;
      background: var(--bg);
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--text-muted);
      font-family: monospace;
    }

    .preview-frame { flex: 1; padding: 20px; overflow: auto; }

    .preview-iframe-wrap {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      height: 100%;
    }

    .preview-iframe-wrap iframe { width: 100%; height: 100%; border: none; }

    .editor-panel {
      background: var(--bg-elevated);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 56px);
    }

    .editor-header { padding: 16px 20px; border-bottom: 1px solid var(--border); }
    .editor-header h2 { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .editor-header p { font-size: 12px; color: var(--text-muted); }
    .editor-content { flex: 1; overflow-y: auto; padding: 16px; }

    .editor-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }

    @media (max-width: 1200px) {
      .editor-layout { grid-template-columns: 1fr; }
      .editor-preview { display: none; }
      .flyer-style-grid { grid-template-columns: 1fr; }
      .schedule-row-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="#" class="logo">
          <div class="logo-icon"><i class="fa-solid fa-church"></i></div>
          <span class="logo-text">Newness of Life</span>
        </a>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Übersicht</div>
          <a class="nav-item active" data-view="dashboard">
            <i class="fa-solid fa-gauge-high"></i>
            Dashboard
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Inhalte</div>
          <a class="nav-item" data-view="pages">
            <i class="fa-solid fa-file-lines"></i>
            Seiten
          </a>
          <a class="nav-item" data-view="events">
            <i class="fa-solid fa-calendar"></i>
            Termine
            <span class="nav-item-badge" id="eventsBadge">0</span>
          </a>
          <a class="nav-item" data-view="media">
            <i class="fa-solid fa-images"></i>
            Medien
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">System</div>
          <a class="nav-item" data-view="settings">
            <i class="fa-solid fa-gear"></i>
            Einstellungen
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="theme-toggle">
          <span class="theme-toggle-label"><i class="fa-solid fa-moon"></i> Dark Mode</span>
          <button class="theme-toggle-btn" onclick="App.toggleTheme()" title="Theme wechseln"></button>
        </div>
        <div class="server-status">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Verbinde...</span>
        </div>
      </div>
    </aside>

    <main class="main">
      <!-- Dashboard -->
      <div id="view-dashboard" class="view active">
        <header class="header">
          <div class="header-left"><h1 class="header-title">Dashboard</h1></div>
          <div class="header-actions">
            <a href="/" target="_blank" class="btn btn-secondary"><i class="fa-solid fa-external-link"></i> Website</a>
            <button class="btn btn-primary" onclick="App.build()"><i class="fa-solid fa-rotate"></i> Neu bauen</button>
          </div>
        </header>

        <div class="content">
          <div class="stats-grid">
            <div class="stat-card"><h3>Termine</h3><div class="value" id="statEvents">-</div></div>
            <div class="stat-card"><h3>Seiten</h3><div class="value">7</div></div>
            <div class="stat-card"><h3>Bilder</h3><div class="value" id="statImages">-</div></div>
          </div>

          <h3 style="font-size: 13px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);">Schnellzugriff</h3>
          <div class="quick-actions">
            <div class="quick-action" onclick="App.showView('events'); App.openEventModal()">
              <div class="quick-action-icon"><i class="fa-solid fa-plus"></i></div>
              <div><h4>Neuer Termin</h4><p>Event erstellen</p></div>
            </div>
            <div class="quick-action" onclick="App.showView('pages')">
              <div class="quick-action-icon"><i class="fa-solid fa-pen"></i></div>
              <div><h4>Seiten</h4><p>Inhalte bearbeiten</p></div>
            </div>
            <div class="quick-action" onclick="App.showView('media')">
              <div class="quick-action-icon"><i class="fa-solid fa-upload"></i></div>
              <div><h4>Medien</h4><p>Bilder verwalten</p></div>
            </div>
            <div class="quick-action" onclick="App.showView('settings')">
              <div class="quick-action-icon"><i class="fa-solid fa-gear"></i></div>
              <div><h4>Einstellungen</h4><p>Konfiguration</p></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h3 class="card-title">Nächste Termine</h3></div>
            <div class="card-body" id="dashboardEvents"><div class="loading"><div class="spinner"></div> Lade...</div></div>
          </div>
        </div>
      </div>

      <!-- Pages -->
      <div id="view-pages" class="view">
        <header class="header"><div class="header-left"><h1 class="header-title">Seiten</h1></div></header>
        <div class="content"><div class="page-grid" id="pagesGrid"></div></div>
      </div>

      <!-- Editor -->
      <div id="view-editor" class="view">
        <header class="header">
          <div class="header-left">
            <button class="btn btn-ghost" onclick="App.showView('pages')"><i class="fa-solid fa-arrow-left"></i></button>
            <h1 class="header-title" id="editorTitle">Seite bearbeiten</h1>
            <span class="header-subtitle" id="editorStatus"></span>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="App.savePage()"><i class="fa-solid fa-save"></i> Speichern</button>
            <button class="btn btn-success" onclick="App.saveAndBuild()"><i class="fa-solid fa-check"></i> Veröffentlichen</button>
          </div>
        </header>

        <div class="content">
          <div class="editor-layout">
            <div class="editor-preview">
              <div class="preview-header">
                <div class="preview-url" id="previewUrl">-</div>
                <button class="btn btn-ghost" onclick="App.refreshPreview()"><i class="fa-solid fa-rotate"></i></button>
                <button class="btn btn-ghost" onclick="App.openPreview()"><i class="fa-solid fa-external-link"></i></button>
              </div>
              <div class="preview-frame">
                <div class="preview-iframe-wrap"><iframe id="previewIframe" src="about:blank"></iframe></div>
              </div>
            </div>

            <div class="editor-panel">
              <div class="editor-header"><h2 id="editorPageTitle">-</h2><p>Inhalte bearbeiten</p></div>
              <div class="editor-content" id="editorContent"><div class="loading"><div class="spinner"></div> Lade...</div></div>
              <div class="editor-footer"><span id="lastSaved">-</span><span>Ctrl+S zum Speichern</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Events -->
      <div id="view-events" class="view">
        <header class="header">
          <div class="header-left">
            <h1 class="header-title">Termine</h1>
            <span class="header-subtitle" id="eventsCount">0 Termine</span>
          </div>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="App.openEventModal()"><i class="fa-solid fa-plus"></i> Neuer Termin</button>
          </div>
        </header>
        <div class="content">
          <div class="events-grid" id="eventsGrid">
            <div class="loading"><div class="spinner"></div> Lade Termine...</div>
          </div>
        </div>
      </div>

      <!-- Media -->
      <div id="view-media" class="view">
        <header class="header">
          <div class="header-left"><h1 class="header-title">Medien</h1></div>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="document.getElementById('uploadInput').click()"><i class="fa-solid fa-upload"></i> Hochladen</button>
            <input type="file" id="uploadInput" accept="image/*" multiple style="display: none" onchange="App.uploadFiles(this.files)">
          </div>
        </header>
        <div class="content">
          <div class="upload-zone" onclick="document.getElementById('uploadInput').click()">
            <i class="fa-solid fa-cloud-arrow-up"></i>
            <h3>Bilder hochladen</h3>
            <p>Klicken oder Dateien hierher ziehen</p>
          </div>
          <div id="mediaContent"><div class="loading"><div class="spinner"></div> Lade...</div></div>
        </div>
      </div>

      <!-- Settings -->
      <div id="view-settings" class="view">
        <header class="header">
          <div class="header-left"><h1 class="header-title">Einstellungen</h1></div>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="App.saveSettings()"><i class="fa-solid fa-save"></i> Speichern</button>
            <button class="btn btn-success" onclick="App.saveSettingsAndBuild()"><i class="fa-solid fa-check"></i> Veröffentlichen</button>
          </div>
        </header>
        <div class="content"><div class="settings-grid" id="settingsContent"><div class="loading"><div class="spinner"></div> Lade...</div></div></div>
      </div>
    </main>
  </div>

  <!-- Event Modal -->
  <div class="modal-overlay" id="eventModal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title" id="eventModalTitle">Neuer Termin</h3>
        <button class="btn btn-ghost" onclick="App.closeEventModal()"><i class="fa-solid fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form id="eventForm">
          <input type="hidden" id="eventId">
          <div class="form-group">
            <label class="form-label">Titel *</label>
            <input type="text" class="form-input" id="eventTitle" required placeholder="Name des Events">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group"><label class="form-label">Datum *</label><input type="date" class="form-input" id="eventDate" required></div>
            <div class="form-group"><label class="form-label">Uhrzeit *</label><input type="time" class="form-input" id="eventTime" required></div>
          </div>
          <div class="form-group"><label class="form-label">Ort *</label><input type="text" class="form-input" id="eventLocation" required placeholder="z.B. In der Gemeinde"></div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label class="form-label">Kategorie</label>
              <select class="form-select" id="eventCategory" onchange="App.updateCategoryDefaults()">
                <option value="gottesdienst">Gottesdienst</option>
                <option value="jugend">Jugend</option>
                <option value="special">Special Event</option>
                <option value="gebet">Gebet</option>
                <option value="gemeinschaft">Gemeinschaft</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Farbe</label>
              <div class="color-picker-row">
                <input type="color" class="color-input" id="eventColor" value="#2563EB">
                <div class="color-presets">
                  <button type="button" class="color-preset" style="background:#2563EB" onclick="App.setEventColor('#2563EB')"></button>
                  <button type="button" class="color-preset" style="background:#10B981" onclick="App.setEventColor('#10B981')"></button>
                  <button type="button" class="color-preset" style="background:#8B5CF6" onclick="App.setEventColor('#8B5CF6')"></button>
                  <button type="button" class="color-preset" style="background:#F59E0B" onclick="App.setEventColor('#F59E0B')"></button>
                  <button type="button" class="color-preset" style="background:#EF4444" onclick="App.setEventColor('#EF4444')"></button>
                  <button type="button" class="color-preset" style="background:#EC4899" onclick="App.setEventColor('#EC4899')"></button>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Icon (wenn kein Bild)</label>
            <div class="icon-picker" id="iconPicker">
              <button type="button" class="icon-option selected" data-icon="fa-calendar" onclick="App.setEventIcon(this)"><i class="fa-solid fa-calendar"></i></button>
              <button type="button" class="icon-option" data-icon="fa-church" onclick="App.setEventIcon(this)"><i class="fa-solid fa-church"></i></button>
              <button type="button" class="icon-option" data-icon="fa-music" onclick="App.setEventIcon(this)"><i class="fa-solid fa-music"></i></button>
              <button type="button" class="icon-option" data-icon="fa-users" onclick="App.setEventIcon(this)"><i class="fa-solid fa-users"></i></button>
              <button type="button" class="icon-option" data-icon="fa-heart" onclick="App.setEventIcon(this)"><i class="fa-solid fa-heart"></i></button>
              <button type="button" class="icon-option" data-icon="fa-pray" onclick="App.setEventIcon(this)"><i class="fa-solid fa-pray"></i></button>
              <button type="button" class="icon-option" data-icon="fa-book-bible" onclick="App.setEventIcon(this)"><i class="fa-solid fa-book-bible"></i></button>
              <button type="button" class="icon-option" data-icon="fa-star" onclick="App.setEventIcon(this)"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="icon-option" data-icon="fa-gift" onclick="App.setEventIcon(this)"><i class="fa-solid fa-gift"></i></button>
              <button type="button" class="icon-option" data-icon="fa-cake-candles" onclick="App.setEventIcon(this)"><i class="fa-solid fa-cake-candles"></i></button>
              <button type="button" class="icon-option" data-icon="fa-mug-hot" onclick="App.setEventIcon(this)"><i class="fa-solid fa-mug-hot"></i></button>
              <button type="button" class="icon-option" data-icon="fa-utensils" onclick="App.setEventIcon(this)"><i class="fa-solid fa-utensils"></i></button>
              <button type="button" class="icon-option" data-icon="fa-fire" onclick="App.setEventIcon(this)"><i class="fa-solid fa-fire"></i></button>
              <button type="button" class="icon-option" data-icon="fa-hands-praying" onclick="App.setEventIcon(this)"><i class="fa-solid fa-hands-praying"></i></button>
              <button type="button" class="icon-option" data-icon="fa-cross" onclick="App.setEventIcon(this)"><i class="fa-solid fa-cross"></i></button>
              <button type="button" class="icon-option" data-icon="fa-dove" onclick="App.setEventIcon(this)"><i class="fa-solid fa-dove"></i></button>
            </div>
            <input type="hidden" id="eventIcon" value="fa-calendar">
          </div>
          <div class="form-group">
            <label class="form-label">Flyer-Bild (optional)</label>
            <div class="event-image-picker">
              <div class="event-image-preview" id="eventImagePreview">
                <i class="fa-solid fa-image"></i>
                <span>Kein Bild ausgewählt</span>
              </div>
              <div class="event-image-actions">
                <button type="button" class="btn btn-secondary btn-sm" onclick="App.openEventImagePicker()"><i class="fa-solid fa-upload"></i> Flyer hochladen</button>
                <button type="button" class="btn btn-ghost btn-sm" id="removeEventImageBtn" style="display: none;" onclick="App.removeEventImage()"><i class="fa-solid fa-trash"></i></button>
              </div>
              <input type="hidden" id="eventImage">
            </div>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">Mit Flyer-Bild wird das Event als großer Flyer angezeigt</p>
            <div class="flyer-style-grid">
              <div class="form-group">
                <label class="form-label">Bildposition</label>
                <select class="form-select" id="eventFlyerPosition" onchange="App.updateFlyerStylePreviewLabels()">
                  <option value="center center">Mitte</option>
                  <option value="center top">Oben</option>
                  <option value="center 30%">Oben-Mitte</option>
                  <option value="center 70%">Unten-Mitte</option>
                  <option value="center bottom">Unten</option>
                  <option value="left center">Links</option>
                  <option value="right center">Rechts</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Zoom <span class="flyer-range-value" id="eventFlyerZoomValue">100%</span></label>
                <input type="range" id="eventFlyerZoom" min="100" max="170" step="5" value="100" oninput="App.updateFlyerStylePreviewLabels()">
              </div>
              <div class="form-group">
                <label class="form-label">Dunkelheit <span class="flyer-range-value" id="eventFlyerOverlayValue">85%</span></label>
                <input type="range" id="eventFlyerOverlay" min="40" max="95" step="5" value="85" oninput="App.updateFlyerStylePreviewLabels()">
              </div>
            </div>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">Diese Optionen wirken nur, wenn Flyer-Layout aktiv ist.</p>
          </div>
          <div class="form-group"><label class="form-label">Beschreibung</label><textarea class="form-textarea" id="eventDescription" placeholder="Beschreibung..."></textarea></div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group"><label class="form-label">Enddatum (optional)</label><input type="date" class="form-input" id="eventEndDate"></div>
            <div class="form-group"><label class="form-label">Endzeit (optional)</label><input type="time" class="form-input" id="eventEndTime"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Programm (mehrere Tage)</label>
            <div class="schedule-editor">
              <div id="eventScheduleList" class="schedule-list"></div>
              <div>
                <button type="button" class="btn btn-secondary btn-sm" onclick="App.addEventScheduleRow()"><i class="fa-solid fa-plus"></i> Programmpunkt hinzufügen</button>
              </div>
            </div>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">Beispiel: Freitag 18:00-21:00, Samstag 10:00-20:00, Sonntag 11:00-14:30.</p>
          </div>
          <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div class="toggle-wrapper"><label class="toggle"><input type="checkbox" id="eventFeatured"><span class="toggle-slider"></span></label><span class="toggle-label">Featured</span></div>
            <div class="toggle-wrapper"><label class="toggle"><input type="checkbox" id="eventPublished" checked><span class="toggle-slider"></span></label><span class="toggle-label">Veröffentlicht</span></div>
            <div class="toggle-wrapper"><label class="toggle"><input type="checkbox" id="eventFlyerLayout"><span class="toggle-slider"></span></label><span class="toggle-label">Flyer-Layout</span></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeEventModal()">Abbrechen</button>
        <button class="btn btn-danger" id="deleteEventBtn" style="display: none;" onclick="App.deleteEvent()"><i class="fa-solid fa-trash"></i> Löschen</button>
        <button class="btn btn-primary" onclick="App.saveEvent()"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="modal-overlay" id="imageModal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title">Bild auswählen</h3>
        <button class="btn btn-ghost" onclick="App.closeImageModal()"><i class="fa-solid fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 16px;">
          <input type="file" id="modalUploadInput" accept="image/*" style="display: none" onchange="App.uploadForModal(this.files)">
          <button class="btn btn-primary" onclick="document.getElementById('modalUploadInput').click()"><i class="fa-solid fa-upload"></i> Neues Bild</button>
        </div>
        <div class="media-grid" id="imageModalGrid"><div class="loading"><div class="spinner"></div></div></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeImageModal()">Abbrechen</button>
        <button class="btn btn-primary" onclick="App.selectImage()">Auswählen</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    const ADMIN_PATH = window.location.pathname;
    const ADMIN_BASE = ADMIN_PATH.includes('/admin/')
      ? ADMIN_PATH.split('/admin/')[0]
      : (ADMIN_PATH.endsWith('/admin') ? ADMIN_PATH.slice(0, -6) : '');
    const QUERY_API = new URLSearchParams(window.location.search).get('api');
    const STORED_API = localStorage.getItem('admin-api');
    const IS_LOCALHOST = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const DEFAULT_API = IS_LOCALHOST
      ? 'http://localhost:3001/api'
      : `${window.location.origin}${ADMIN_BASE}/api`;
    const DEFAULT_SITE = IS_LOCALHOST
      ? 'http://localhost:8080'
      : `${window.location.origin}${ADMIN_BASE}`;

    const App = {
      API: (QUERY_API || STORED_API || DEFAULT_API).replace(/\/+$/, ''),
      SITE: DEFAULT_SITE.replace(/\/+$/, ''),
      currentPage: null,
      pageData: {},
      eventsData: { categories: [], items: [] },
      settingsData: {},
      imagesData: [],
      hasChanges: false,
      selectedImage: null,
      imageFieldCallback: null,
      eventImageCallback: false,
      readOnlyNoticeShown: false,

      pages: {
        homepage: { title: 'Startseite', icon: 'fa-home', file: 'homepage.json', url: '/index.html', desc: 'Hero, Gottesdienste, Über uns', sections: [
          { id: 'hero', title: 'Hero-Bereich', icon: 'fa-star', fields: [
            { key: 'hero.title', label: 'Haupttitel', type: 'text' },
            { key: 'hero.subtitle', label: 'Untertitel', type: 'textarea' },
            { key: 'hero.background_image', label: 'Hintergrundbild', type: 'image' },
            { key: 'hero.cta_text', label: 'Button Text', type: 'text' },
            { key: 'hero.cta_link', label: 'Button Link', type: 'text' }
          ]},
          { id: 'services', title: 'Gottesdienste', icon: 'fa-church', fields: [
            { key: 'services_section.title', label: 'Titel', type: 'text' },
            { key: 'services_section.description', label: 'Beschreibung', type: 'textarea' },
            { key: 'services_section.service_day', label: 'Tag', type: 'text' },
            { key: 'services_section.service_time', label: 'Uhrzeit', type: 'text' }
          ]},
          { id: 'about', title: 'Über uns', icon: 'fa-users', fields: [
            { key: 'about_section.title', label: 'Titel', type: 'text' },
            { key: 'about_section.subtitle', label: 'Untertitel', type: 'text' },
            { key: 'about_section.text', label: 'Text', type: 'textarea' }
          ]},
          { id: 'seo', title: 'SEO', icon: 'fa-search', fields: [
            { key: 'seo.meta_title', label: 'Meta Titel', type: 'text' },
            { key: 'seo.meta_description', label: 'Meta Beschreibung', type: 'textarea' }
          ]}
        ]},
        gottesdienste: { title: 'Gottesdienste', icon: 'fa-church', file: 'gottesdienste.json', url: '/gottesdienste.html', desc: 'Zeiten, Ort, Infos', isPageData: true, sections: [
          { id: 'hero', title: 'Hero', icon: 'fa-image', fields: [
            { key: 'hero.title', label: 'Titel', type: 'text' },
            { key: 'hero.subtitle', label: 'Untertitel', type: 'text' }
          ]},
          { id: 'intro', title: 'Einleitung', icon: 'fa-align-left', fields: [
            { key: 'intro.title', label: 'Titel', type: 'text' },
            { key: 'intro.text', label: 'Text', type: 'textarea' }
          ]},
          { id: 'main', title: 'Hauptgottesdienst', icon: 'fa-clock', fields: [
            { key: 'main_service.title', label: 'Titel', type: 'text' },
            { key: 'main_service.day', label: 'Tag (z.B. Sonntag)', type: 'text' },
            { key: 'main_service.time', label: 'Uhrzeit (z.B. 14:00 Uhr)', type: 'text' },
            { key: 'main_service.duration', label: 'Dauer (z.B. ca. 2 Stunden)', type: 'text' },
            { key: 'main_service.description', label: 'Beschreibung', type: 'textarea' }
          ]},
          { id: 'location', title: 'Standort & Anfahrt', icon: 'fa-location-dot', fields: [
            { key: 'anfahrt.title', label: 'Abschnitt-Titel', type: 'text' },
            { key: 'anfahrt.text', label: 'Anfahrtsbeschreibung', type: 'textarea' },
            { key: 'location.parking_info', label: 'Parkplatz-Info', type: 'text' },
            { key: 'location.accessibility_info', label: 'Barrierefreiheit', type: 'text' }
          ]},
          { id: 'cta', title: 'Call-to-Action', icon: 'fa-bullhorn', fields: [
            { key: 'cta.title', label: 'Titel', type: 'text' },
            { key: 'cta.text', label: 'Text', type: 'textarea' },
            { key: 'cta.button_text', label: 'Button Text', type: 'text' },
            { key: 'cta.button_link', label: 'Button Link', type: 'text' }
          ]},
          { id: 'seo', title: 'SEO', icon: 'fa-search', fields: [
            { key: 'seo.meta_title', label: 'Meta Titel', type: 'text' },
            { key: 'seo.meta_description', label: 'Meta Beschreibung', type: 'textarea' }
          ]}
        ]},
        'ueber-uns': { title: 'Über uns', icon: 'fa-users', file: 'ueber-uns.json', url: '/ueber-uns.html', desc: 'Geschichte, Vision, Glaube', isPageData: true, sections: [
          { id: 'hero', title: 'Hero', icon: 'fa-image', fields: [
            { key: 'hero.title', label: 'Titel', type: 'text' },
            { key: 'hero.subtitle', label: 'Untertitel', type: 'text' }
          ]},
          { id: 'intro', title: 'Einleitung', icon: 'fa-align-left', fields: [
            { key: 'intro.title', label: 'Titel', type: 'text' },
            { key: 'intro.text', label: 'Text', type: 'textarea' }
          ]},
          { id: 'story', title: 'Geschichte', icon: 'fa-book', fields: [
            { key: 'story.title', label: 'Titel', type: 'text' },
            { key: 'story.text', label: 'Text', type: 'textarea' },
            { key: 'story.image', label: 'Bild', type: 'image' }
          ]},
          { id: 'vision', title: 'Vision & Mission', icon: 'fa-eye', fields: [
            { key: 'vision.title', label: 'Titel', type: 'text' },
            { key: 'vision.text', label: 'Text', type: 'textarea' }
          ]},
          { id: 'seo', title: 'SEO', icon: 'fa-search', fields: [
            { key: 'seo.meta_title', label: 'Meta Titel', type: 'text' },
            { key: 'seo.meta_description', label: 'Meta Beschreibung', type: 'textarea' }
          ]}
        ]},
        spenden: { title: 'Spenden', icon: 'fa-hand-holding-heart', file: 'spenden.json', url: '/spenden.html', desc: 'Bankverbindung, PayPal', isPageData: true, sections: [
          { id: 'hero', title: 'Hero', icon: 'fa-image', fields: [
            { key: 'hero.title', label: 'Titel', type: 'text' },
            { key: 'hero.subtitle', label: 'Untertitel', type: 'textarea' }
          ]},
          { id: 'intro', title: 'Einleitung', icon: 'fa-align-left', fields: [
            { key: 'intro.title', label: 'Titel', type: 'text' },
            { key: 'intro.text', label: 'Text', type: 'textarea' }
          ]},
          { id: 'bank', title: 'Bankverbindung', icon: 'fa-building-columns', fields: [
            { key: 'bank_details.title', label: 'Abschnitt-Titel', type: 'text' },
            { key: 'bank_details.account_holder', label: 'Kontoinhaber', type: 'text' },
            { key: 'bank_details.iban', label: 'IBAN', type: 'text' },
            { key: 'bank_details.bic', label: 'BIC', type: 'text' },
            { key: 'bank_details.bank_name', label: 'Bank Name', type: 'text' },
            { key: 'bank_details.reference', label: 'Verwendungszweck', type: 'text' }
          ]},
          { id: 'online', title: 'Online Spenden', icon: 'fa-credit-card', fields: [
            { key: 'online_donation.enabled', label: 'Online-Spenden aktiviert', type: 'toggle' },
            { key: 'online_donation.paypal_link', label: 'PayPal Link', type: 'text' },
            { key: 'online_donation.other_link', label: 'Anderer Spenden-Link', type: 'text' }
          ]},
          { id: 'seo', title: 'SEO', icon: 'fa-search', fields: [
            { key: 'seo.meta_title', label: 'Meta Titel', type: 'text' },
            { key: 'seo.meta_description', label: 'Meta Beschreibung', type: 'textarea' }
          ]}
        ]},
        'service-karten': { title: 'Service-Boxen', icon: 'fa-layer-group', file: 'global.json', url: '/index.html', desc: 'Karten bearbeiten, ausblenden, löschen', editorType: 'serviceCards', sections: [] },
        global: { title: 'Header & Footer', icon: 'fa-globe', file: 'global.json', url: '/index.html', desc: 'Logo, Navigation', sections: [
          { id: 'header', title: 'Header / Logo', icon: 'fa-heading', fields: [
            { key: 'header.logo.text', label: 'Logo Text', type: 'text' },
            { key: 'header.logo.subtext', label: 'Untertitel', type: 'text' },
            { key: 'header.logo.image', label: 'Logo Bild', type: 'image' }
          ]},
          { id: 'footer', title: 'Footer', icon: 'fa-shoe-prints', fields: [
            { key: 'footer.about_text', label: 'Über uns Text', type: 'textarea' },
            { key: 'footer.copyright', label: 'Copyright', type: 'text' },
            { key: 'footer.donation_text', label: 'Spenden-Text', type: 'text' }
          ]}
        ]}
      },

      init() {
        this.setupNavigation();
        this.loadTheme();
        this.checkServer();
        this.loadDashboard();
        setInterval(() => this.checkServer(), 30000);
        document.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); if (this.currentPage) this.savePage(); }
        });
        window.addEventListener('beforeunload', (e) => { if (this.hasChanges) { e.preventDefault(); e.returnValue = ''; } });
      },

      loadTheme() {
        const saved = localStorage.getItem('admin-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', saved);
        this.updateThemeLabel(saved);
      },

      toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme') || 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('admin-theme', next);
        this.updateThemeLabel(next);
      },

      updateThemeLabel(theme) {
        const label = document.querySelector('.theme-toggle-label');
        if (label) {
          label.innerHTML = theme === 'dark'
            ? '<i class="fa-solid fa-moon"></i> Dark Mode'
            : '<i class="fa-solid fa-sun"></i> Light Mode';
        }
      },

      setupNavigation() {
        document.querySelectorAll('[data-view]').forEach(el => {
          el.addEventListener('click', (e) => { e.preventDefault(); this.showView(el.dataset.view); });
        });
      },

      showView(viewId, pageId = null) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${viewId}`).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelector(`[data-view="${viewId}"]`)?.classList.add('active');

        if (viewId === 'dashboard') this.loadDashboard();
        else if (viewId === 'pages') this.renderPagesGrid();
        else if (viewId === 'events') this.loadEvents();
        else if (viewId === 'media') this.loadMedia();
        else if (viewId === 'settings') this.loadSettings();
        else if (viewId === 'editor' && pageId) this.loadPageEditor(pageId);
      },

      getStaticDataUrl(endpoint) {
        const rel = endpoint.replace(/^\/data\//, 'data/');
        return `../${rel}`;
      },

      showReadOnlyNotice() {
        if (this.readOnlyNoticeShown) return;
        this.readOnlyNoticeShown = true;
        this.toast('API offline: Daten werden nur lesend aus statischen JSON-Dateien geladen.', 'info');
      },

      async api(endpoint, options = {}) {
        const method = (options.method || 'GET').toUpperCase();
        const isReadableDataEndpoint = method === 'GET' && /^\/data\/.+\.json$/.test(endpoint);

        try {
          const res = await fetch(`${this.API}${endpoint}`, { ...options, headers: { 'Content-Type': 'application/json', ...options.headers } });
          let data = {};
          try {
            data = await res.json();
          } catch {
            data = {};
          }
          if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
          return data;
        } catch (err) {
          if (isReadableDataEndpoint) {
            const staticRes = await fetch(this.getStaticDataUrl(endpoint));
            if (staticRes.ok) {
              this.showReadOnlyNotice();
              return staticRes.json();
            }
          }
          throw err;
        }
      },

      async checkServer() {
        const dot = document.getElementById('statusDot'), text = document.getElementById('statusText');
        try { await this.api('/status'); dot.classList.add('online'); text.textContent = 'Verbunden'; }
        catch { dot.classList.remove('online'); text.textContent = 'Offline'; }
      },

      toast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fa-solid fa-${type === 'success' ? 'check' : type === 'error' ? 'xmark' : 'info'}"></i> ${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      },

      async loadDashboard() {
        try {
          const [events, images] = await Promise.all([this.api('/data/events.json'), this.api('/images')]);
          this.eventsData = events; this.imagesData = images;
          document.getElementById('statEvents').textContent = events.items?.length || 0;
          document.getElementById('statImages').textContent = images.length || 0;
          document.getElementById('eventsBadge').textContent = events.items?.length || 0;

          const container = document.getElementById('dashboardEvents');
          const items = (events.items || []).filter(e => e.published).slice(0, 5);
          if (items.length === 0) container.innerHTML = '<div class="empty-state"><p>Keine Termine</p></div>';
          else container.innerHTML = items.map(e => `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);"><div><div class="event-title">${e.title}</div><div class="event-meta">${new Date(e.date).toLocaleDateString('de-DE')}</div></div><span class="badge ${e.featured ? 'badge-warning' : 'badge-success'}">${e.featured ? 'Featured' : 'Aktiv'}</span></div>`).join('');
        } catch { this.toast('Fehler beim Laden', 'error'); }
      },

      renderPagesGrid() {
        document.getElementById('pagesGrid').innerHTML = Object.entries(this.pages).map(([id, page]) => `<div class="page-card" onclick="App.showView('editor', '${id}'); App.loadPageEditor('${id}')"><div class="page-card-preview"><i class="fa-solid ${page.icon}"></i></div><div class="page-card-body"><div class="page-card-title">${page.title}</div><div class="page-card-desc">${page.desc}</div></div></div>`).join('');
      },

      async loadPageEditor(pageId) {
        const config = this.pages[pageId]; if (!config) return;
        this.currentPage = { id: pageId, ...config };
        document.getElementById('editorTitle').textContent = config.title;
        document.getElementById('editorPageTitle').textContent = config.title;
        document.getElementById('previewUrl').textContent = 'localhost:8080' + config.url;
        document.getElementById('previewIframe').src = this.SITE + config.url + '?t=' + Date.now();
        // Page data files are in data/pages/, others in data/
        const filePath = config.isPageData ? `pages/${config.file}` : config.file;
        try { this.pageData = await this.api(`/data/${filePath}`); } catch { this.pageData = {}; }
        this.renderEditor(); this.hasChanges = false; this.updateEditorStatus();
      },

      renderEditor() {
        const container = document.getElementById('editorContent');
        let html = '';

        if (this.currentPage.id === 'index') {
          html += `<div class="editor-note"><span><i class="fa-solid fa-circle-info"></i>Service-Boxen werden separat bearbeitet.</span><button type="button" class="btn btn-secondary btn-sm" onclick="App.showView('editor', 'service-karten')"><i class="fa-solid fa-layer-group"></i> Service-Boxen öffnen</button></div>`;
        }

        if (this.currentPage.editorType === 'serviceCards') {
          container.innerHTML = html + this.renderServiceCardsEditor();
          return;
        }

        for (const section of this.currentPage.sections) {
          html += `<div class="form-section" data-section="${section.id}"><div class="form-section-header" onclick="this.parentElement.classList.toggle('collapsed')"><i class="fa-solid ${section.icon}"></i><h3>${section.title}</h3><i class="fa-solid fa-chevron-down form-section-toggle"></i></div><div class="form-section-body">`;
          for (const field of section.fields) {
            const value = this.getValue(this.pageData, field.key);
            const escaped = this.escapeHtml(value || '');
            if (field.type === 'textarea') {
              html += `<div class="form-group"><label class="form-label">${field.label}</label><textarea class="form-textarea" data-key="${field.key}" oninput="App.handleInput(this)">${escaped}</textarea></div>`;
            } else if (field.type === 'image') {
              html += `<div class="form-group"><label class="form-label">${field.label}</label><div class="image-field"><div class="image-preview">${value ? `<img src="${this.SITE}${value}" alt="">` : '<i class="fa-solid fa-image image-preview-empty"></i>'}</div><div class="image-actions"><button type="button" class="btn btn-secondary btn-sm" onclick="App.openImagePicker('${field.key}')"><i class="fa-solid fa-image"></i> Auswählen</button>${value ? `<button type="button" class="btn btn-secondary btn-sm" onclick="App.removeImage('${field.key}')"><i class="fa-solid fa-trash"></i></button>` : ''}</div></div><input type="hidden" data-key="${field.key}" value="${escaped}"></div>`;
            } else if (field.type === 'toggle') {
              const checked = value === true || value === 'true';
              html += `<div class="form-group"><div class="toggle-wrapper"><label class="toggle"><input type="checkbox" data-key="${field.key}" ${checked ? 'checked' : ''} onchange="App.handleToggle(this)"><span class="toggle-slider"></span></label><span class="toggle-label">${field.label}</span></div></div>`;
            } else {
              html += `<div class="form-group"><label class="form-label">${field.label}</label><input type="text" class="form-input" data-key="${field.key}" value="${escaped}" oninput="App.handleInput(this)"></div>`;
            }
          }
          html += `</div></div>`;
        }
        container.innerHTML = html;
      },

      ensureServiceCards() {
        if (!Array.isArray(this.pageData.service_cards)) {
          this.pageData.service_cards = [];
        }
        return this.pageData.service_cards;
      },

      createDefaultServiceCard() {
        return {
          label: '',
          title: 'Neue Box',
          time: '',
          image: '',
          link: '',
          show: true
        };
      },

      renderServiceCardsEditor() {
        const cards = this.ensureServiceCards();
        let html = `
          <div class="editor-note">
            <span><i class="fa-solid fa-pen-to-square"></i>Hier kannst du Boxen bearbeiten, ausblenden oder komplett entfernen.</span>
          </div>
          <div class="editor-toolbar">
            <button type="button" class="btn btn-primary btn-sm" onclick="App.addServiceCard()"><i class="fa-solid fa-plus"></i> Box hinzufügen</button>
          </div>
        `;

        if (!cards.length) {
          html += `<div class="empty-state"><i class="fa-solid fa-layer-group"></i><h3>Keine Service-Boxen vorhanden</h3><p>Erstelle eine neue Box für die Startseite.</p><button type="button" class="btn btn-primary" onclick="App.addServiceCard()"><i class="fa-solid fa-plus"></i> Erste Box anlegen</button></div>`;
          return html;
        }

        cards.forEach((card, index) => {
          const current = card && typeof card === 'object' ? card : this.createDefaultServiceCard();
          const title = this.escapeHtml(current.title || `Box ${index + 1}`);
          const label = this.escapeHtml(current.label || '');
          const time = this.escapeHtml(current.time || '');
          const link = this.escapeHtml(current.link || '');
          const image = current.image || '';
          const showChecked = current.show !== false ? 'checked' : '';
          const visibilityBadge = current.show !== false
            ? '<span class="badge badge-success">Sichtbar</span>'
            : '<span class="badge badge-warning">Versteckt</span>';

          html += `
            <div class="form-section" data-section="service-card-${index}">
              <div class="form-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                <i class="fa-solid fa-layer-group"></i>
                <h3>Box ${index + 1}: ${title}</h3>
                ${visibilityBadge}
                <i class="fa-solid fa-chevron-down form-section-toggle"></i>
              </div>
              <div class="form-section-body">
                <div class="section-actions">
                  <button type="button" class="btn btn-secondary btn-sm" onclick="App.moveServiceCard(${index}, -1)" ${index === 0 ? 'disabled' : ''}><i class="fa-solid fa-arrow-up"></i> Nach oben</button>
                  <button type="button" class="btn btn-secondary btn-sm" onclick="App.moveServiceCard(${index}, 1)" ${index === cards.length - 1 ? 'disabled' : ''}><i class="fa-solid fa-arrow-down"></i> Nach unten</button>
                  <button type="button" class="btn btn-secondary btn-sm" onclick="App.duplicateServiceCard(${index})"><i class="fa-solid fa-copy"></i> Duplizieren</button>
                  <button type="button" class="btn btn-danger btn-sm" onclick="App.removeServiceCard(${index})"><i class="fa-solid fa-trash"></i> Löschen</button>
                </div>

                <div class="form-group">
                  <div class="toggle-wrapper">
                    <label class="toggle">
                      <input type="checkbox" data-key="service_cards.${index}.show" ${showChecked} onchange="App.handleToggle(this)">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">Auf Startseite anzeigen</span>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Bild</label>
                  <div class="image-field">
                    <div class="image-preview">${image ? `<img src="${this.SITE}${image}" alt="">` : '<i class="fa-solid fa-image image-preview-empty"></i>'}</div>
                    <div class="image-actions">
                      <button type="button" class="btn btn-secondary btn-sm" onclick="App.openImagePicker('service_cards.${index}.image')"><i class="fa-solid fa-image"></i> Auswählen</button>
                      ${image ? `<button type="button" class="btn btn-secondary btn-sm" onclick="App.removeImage('service_cards.${index}.image')"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </div>
                  </div>
                  <input type="hidden" data-key="service_cards.${index}.image" value="${this.escapeHtml(image)}">
                </div>

                <div class="form-group">
                  <label class="form-label">Label (oben)</label>
                  <input type="text" class="form-input" data-key="service_cards.${index}.label" value="${label}" oninput="App.handleInput(this)">
                </div>

                <div class="form-group">
                  <label class="form-label">Titel</label>
                  <input type="text" class="form-input" data-key="service_cards.${index}.title" value="${title}" oninput="App.handleInput(this)">
                </div>

                <div class="form-group">
                  <label class="form-label">Zeit / Beschreibung</label>
                  <input type="text" class="form-input" data-key="service_cards.${index}.time" value="${time}" oninput="App.handleInput(this)">
                </div>

                <div class="form-group">
                  <label class="form-label">Link (optional)</label>
                  <input type="text" class="form-input" data-key="service_cards.${index}.link" value="${link}" oninput="App.handleInput(this)">
                </div>
              </div>
            </div>
          `;
        });

        return html;
      },

      addServiceCard() {
        const cards = this.ensureServiceCards();
        cards.push(this.createDefaultServiceCard());
        this.hasChanges = true;
        this.updateEditorStatus();
        this.renderEditor();
      },

      duplicateServiceCard(index) {
        const cards = this.ensureServiceCards();
        if (!cards[index]) return;
        const clone = JSON.parse(JSON.stringify(cards[index]));
        cards.splice(index + 1, 0, clone);
        this.hasChanges = true;
        this.updateEditorStatus();
        this.renderEditor();
      },

      removeServiceCard(index) {
        const cards = this.ensureServiceCards();
        if (!cards[index]) return;
        if (!confirm('Diese Box wirklich entfernen?')) return;
        cards.splice(index, 1);
        this.hasChanges = true;
        this.updateEditorStatus();
        this.renderEditor();
      },

      moveServiceCard(index, direction) {
        const cards = this.ensureServiceCards();
        const newIndex = index + direction;
        if (index < 0 || newIndex < 0 || index >= cards.length || newIndex >= cards.length) return;
        const [item] = cards.splice(index, 1);
        cards.splice(newIndex, 0, item);
        this.hasChanges = true;
        this.updateEditorStatus();
        this.renderEditor();
      },

      handleInput(input) { this.setValue(this.pageData, input.dataset.key, input.value); this.hasChanges = true; this.updateEditorStatus(); },
      handleToggle(input) { this.setValue(this.pageData, input.dataset.key, input.checked); this.hasChanges = true; this.updateEditorStatus(); },
      updateEditorStatus() { const s = document.getElementById('editorStatus'); s.textContent = this.hasChanges ? '• Ungespeichert' : ''; s.style.color = this.hasChanges ? 'var(--warning)' : ''; },

      async savePage() {
        if (!this.currentPage) return;
        const filePath = this.currentPage.isPageData ? `pages/${this.currentPage.file}` : this.currentPage.file;
        try {
          console.log('Saving:', filePath, this.pageData);
          await this.api(`/data/${filePath}`, { method: 'PUT', body: JSON.stringify(this.pageData) });
          this.hasChanges = false; this.updateEditorStatus();
          document.getElementById('lastSaved').textContent = 'Gespeichert um ' + new Date().toLocaleTimeString('de-DE');
          this.toast('Gespeichert!', 'success');
        } catch (err) { console.error('Save error:', err); this.toast('Fehler beim Speichern: ' + err.message, 'error'); }
      },

      async saveAndBuild() { await this.savePage(); await this.build(); this.refreshPreview(); },

      async build() {
        try { this.toast('Baue Website...', 'info'); await this.api('/build', { method: 'POST' }); this.toast('Website gebaut!', 'success'); }
        catch { this.toast('Build fehlgeschlagen', 'error'); }
      },

      refreshPreview() { const iframe = document.getElementById('previewIframe'); iframe.src = iframe.src.split('?')[0] + '?t=' + Date.now(); },
      openPreview() { if (this.currentPage) window.open(this.SITE + this.currentPage.url, '_blank'); },

      async loadEvents() {
        try { this.eventsData = await this.api('/data/events.json'); this.renderEventsTable(); }
        catch (err) { this.toast(`Fehler beim Laden: ${err.message || 'Unbekannt'}`, 'error'); }
      },

      renderEventsTable() {
        const grid = document.getElementById('eventsGrid');
        const items = this.eventsData.items || [];
        const categories = this.eventsData.categories || [];

        document.getElementById('eventsCount').textContent = `${items.length} Termin${items.length !== 1 ? 'e' : ''}`;

        if (items.length === 0) {
          grid.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><i class="fa-solid fa-calendar-plus" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px;"></i><h3>Keine Termine vorhanden</h3><p style="color: var(--text-muted); margin-bottom: 16px;">Erstelle deinen ersten Termin</p><button class="btn btn-primary" onclick="App.openEventModal()"><i class="fa-solid fa-plus"></i> Neuer Termin</button></div>`;
          return;
        }

        // Sort by date (upcoming first) - gleiche Reihenfolge wie Website
        const sorted = [...items].sort((a, b) => new Date(a.date) - new Date(b.date));

        grid.innerHTML = sorted.map(e => {
          const cat = categories.find(c => c.id === e.category) || { name: e.category, color: '#666', icon: 'fa-calendar' };
          const date = new Date(e.date);
          const endDate = e.end_date ? new Date(e.end_date) : null;
          const hasEndDate = endDate && !Number.isNaN(endDate.getTime()) && endDate > date;
          const hasSchedule = Array.isArray(e.schedule) && e.schedule.length > 0;
          const flyerStyle = this.normalizeFlyerStyle(e.flyer_style || {});
          const imageStyle = `object-position:${flyerStyle.position}; transform:scale(${(flyerStyle.zoom / 100).toFixed(2)}); transform-origin:${flyerStyle.position};`;
          const dateStr = date.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
          const endDateStr = hasEndDate ? endDate.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' }) : '';
          const timeStr = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
          const endTimeStr = hasEndDate ? endDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '';
          const sameDayRange = hasEndDate && date.toDateString() === endDate.toDateString();
          const isPast = date < new Date();

          return `<div class="event-card ${e.published ? '' : 'unpublished'}">
            <div class="event-card-image" style="background: linear-gradient(135deg, ${cat.color}22, ${cat.color}44);">
              ${e.image ? `<img src="${this.SITE}${e.image}" alt="${this.escapeHtml(e.title)}" style="${imageStyle}">` : `<i class="fa-solid ${cat.icon}" style="color: ${cat.color};"></i>`}
              <div class="event-card-badges">
                ${e.featured ? '<span class="badge badge-warning"><i class="fa-solid fa-star"></i> Featured</span>' : ''}
                ${!e.published ? '<span class="badge badge-secondary">Entwurf</span>' : ''}
                ${isPast ? '<span class="badge badge-secondary">Vergangen</span>' : ''}
                ${e.flyerLayout ? '<span class="badge badge-info"><i class="fa-solid fa-image"></i> Flyer</span>' : ''}
                ${hasSchedule ? `<span class="badge badge-info"><i class="fa-solid fa-list-check"></i> ${e.schedule.length} Tage</span>` : ''}
              </div>
            </div>
            <div class="event-card-body">
              <div class="event-card-category" style="background: ${cat.color}22; color: ${cat.color};"><i class="fa-solid ${cat.icon}"></i> ${cat.name}</div>
              <div class="event-card-title">${this.escapeHtml(e.title)}</div>
              <div class="event-card-info">
                <div class="event-card-info-item"><i class="fa-solid fa-calendar"></i> ${hasEndDate ? `${dateStr} - ${endDateStr}` : dateStr}</div>
                <div class="event-card-info-item"><i class="fa-solid fa-clock"></i> ${sameDayRange ? `${timeStr} - ${endTimeStr} Uhr` : `${timeStr} Uhr`}</div>
                ${e.location ? `<div class="event-card-info-item"><i class="fa-solid fa-location-dot"></i> ${this.escapeHtml(e.location)}</div>` : ''}
              </div>
              ${e.description ? `<div class="event-card-desc">${this.escapeHtml(e.description)}</div>` : ''}
              <div class="event-card-actions">
                <button class="btn btn-secondary btn-sm" onclick="App.editEvent('${e.id}')"><i class="fa-solid fa-pen"></i> Bearbeiten</button>
                <button class="btn btn-ghost btn-sm" onclick="App.duplicateEvent('${e.id}')" title="Duplizieren"><i class="fa-solid fa-copy"></i></button>
                <button class="btn btn-ghost btn-sm" onclick="App.quickDeleteEvent('${e.id}')" title="Löschen"><i class="fa-solid fa-trash"></i></button>
              </div>
            </div>
          </div>`;
        }).join('');
      },

      async duplicateEvent(id) {
        const event = this.eventsData.items.find(e => e.id === id);
        if (!event) return;
        const newEvent = { ...event, id: Date.now().toString(), title: event.title + ' (Kopie)', published: false };
        this.eventsData.items.push(newEvent);
        try {
          await this.api('/data/events.json', { method: 'PUT', body: JSON.stringify(this.eventsData) });
          this.renderEventsTable();
          this.toast('Termin dupliziert!', 'success');
        } catch { this.toast('Fehler', 'error'); }
      },

      async quickDeleteEvent(id) {
        if (!confirm('Termin wirklich löschen?')) return;
        this.eventsData.items = this.eventsData.items.filter(e => e.id !== id);
        try {
          await this.api('/data/events.json', { method: 'PUT', body: JSON.stringify(this.eventsData) });
          await this.api('/build', { method: 'POST' });
          this.renderEventsTable();
          this.toast('Termin gelöscht!', 'success');
        } catch { this.toast('Fehler', 'error'); }
      },

      openEventModal(event = null) {
        document.getElementById('eventModal').classList.add('active');
        document.getElementById('eventModalTitle').textContent = event ? 'Termin bearbeiten' : 'Neuer Termin';
        document.getElementById('deleteEventBtn').style.display = event ? 'block' : 'none';
        if (event) {
          document.getElementById('eventId').value = event.id;
          document.getElementById('eventTitle').value = event.title || '';
          document.getElementById('eventDate').value = event.date?.split('T')[0] || '';
          document.getElementById('eventTime').value = event.date?.split('T')[1]?.substring(0,5) || '';
          document.getElementById('eventLocation').value = event.location || '';
          document.getElementById('eventCategory').value = event.category || 'gottesdienst';
          document.getElementById('eventImage').value = event.image || '';
          document.getElementById('eventDescription').value = event.description || '';
          document.getElementById('eventFeatured').checked = event.featured || false;
          document.getElementById('eventPublished').checked = event.published !== false;
          document.getElementById('eventFlyerLayout').checked = event.flyerLayout || false;
          this.setEventEndDateTime(event.end_date || '');
          this.renderEventScheduleRows(event.schedule || []);
          const flyerStyle = (event.flyer_style && typeof event.flyer_style === 'object') ? event.flyer_style : {};
          const flyerPosition = flyerStyle.position || 'center center';
          const flyerZoom = Number.isFinite(Number(flyerStyle.zoom)) ? Math.round(Number(flyerStyle.zoom)) : 100;
          const flyerOverlay = Number.isFinite(Number(flyerStyle.overlay)) ? Math.round(Number(flyerStyle.overlay)) : 85;
          const flyerPositionEl = document.getElementById('eventFlyerPosition');
          flyerPositionEl.value = flyerPosition;
          if (flyerPositionEl.value !== flyerPosition) flyerPositionEl.value = 'center center';
          document.getElementById('eventFlyerZoom').value = flyerZoom;
          document.getElementById('eventFlyerOverlay').value = flyerOverlay;
          // Icon and color
          const icon = event.icon || 'fa-calendar';
          const color = event.color || '#2563EB';
          document.getElementById('eventIcon').value = icon;
          document.getElementById('eventColor').value = color;
          document.querySelectorAll('#iconPicker .icon-option').forEach(b => {
            b.classList.toggle('selected', b.dataset.icon === icon);
          });
          this.updateEventImagePreview(event.image);
          this.updateFlyerStylePreviewLabels();
        } else {
          document.getElementById('eventForm').reset();
          document.getElementById('eventId').value = '';
          document.getElementById('eventPublished').checked = true;
          this.setEventEndDateTime('');
          this.renderEventScheduleRows([]);
          document.getElementById('eventFlyerPosition').value = 'center center';
          document.getElementById('eventFlyerZoom').value = 100;
          document.getElementById('eventFlyerOverlay').value = 85;
          document.getElementById('eventIcon').value = 'fa-calendar';
          document.getElementById('eventColor').value = '#2563EB';
          document.querySelectorAll('#iconPicker .icon-option').forEach(b => {
            b.classList.toggle('selected', b.dataset.icon === 'fa-calendar');
          });
          this.updateEventImagePreview('');
          this.updateFlyerStylePreviewLabels();
        }
      },

      updateEventImagePreview(imageUrl) {
        const preview = document.getElementById('eventImagePreview');
        const removeBtn = document.getElementById('removeEventImageBtn');
        if (imageUrl) {
          preview.innerHTML = `<img src="${this.SITE}${imageUrl}" alt="Event Bild" id="eventImagePreviewImg">`;
          preview.classList.add('has-image');
          removeBtn.style.display = 'block';
          this.applyFlyerPreviewStyle();
        } else {
          preview.innerHTML = '<i class="fa-solid fa-image"></i><span>Kein Bild ausgewählt</span>';
          preview.classList.remove('has-image');
          removeBtn.style.display = 'none';
        }
      },

      updateFlyerStylePreviewLabels() {
        const zoom = parseInt(document.getElementById('eventFlyerZoom').value, 10);
        const overlay = parseInt(document.getElementById('eventFlyerOverlay').value, 10);
        document.getElementById('eventFlyerZoomValue').textContent = `${Number.isFinite(zoom) ? zoom : 100}%`;
        document.getElementById('eventFlyerOverlayValue').textContent = `${Number.isFinite(overlay) ? overlay : 85}%`;
        this.applyFlyerPreviewStyle();
      },

      getCurrentFlyerStyle() {
        const position = document.getElementById('eventFlyerPosition').value || 'center center';
        const zoomRaw = parseInt(document.getElementById('eventFlyerZoom').value, 10);
        const overlayRaw = parseInt(document.getElementById('eventFlyerOverlay').value, 10);
        const zoom = Number.isFinite(zoomRaw) ? Math.min(200, Math.max(80, zoomRaw)) : 100;
        const overlay = Number.isFinite(overlayRaw) ? Math.min(95, Math.max(35, overlayRaw)) : 85;
        return { position, zoom, overlay };
      },

      normalizeFlyerStyle(raw = {}) {
        const allowed = new Set([
          'center center',
          'center top',
          'center 30%',
          'center 70%',
          'center bottom',
          'left center',
          'right center'
        ]);
        const position = allowed.has(raw.position) ? raw.position : 'center center';
        const zoomNum = Number(raw.zoom);
        const overlayNum = Number(raw.overlay);
        const zoom = Number.isFinite(zoomNum) ? Math.min(200, Math.max(80, Math.round(zoomNum))) : 100;
        const overlay = Number.isFinite(overlayNum) ? Math.min(95, Math.max(35, Math.round(overlayNum))) : 85;
        return { position, zoom, overlay };
      },

      applyFlyerPreviewStyle() {
        const img = document.getElementById('eventImagePreviewImg');
        if (!img) return;
        const style = this.getCurrentFlyerStyle();
        img.style.objectPosition = style.position;
        img.style.transform = `scale(${(style.zoom / 100).toFixed(2)})`;
        img.style.transformOrigin = style.position;
      },

      setEventEndDateTime(endDateTime) {
        const endDateInput = document.getElementById('eventEndDate');
        const endTimeInput = document.getElementById('eventEndTime');
        if (!endDateTime || typeof endDateTime !== 'string') {
          endDateInput.value = '';
          endTimeInput.value = '';
          return;
        }
        const [datePart, timePart = ''] = endDateTime.split('T');
        endDateInput.value = datePart || '';
        endTimeInput.value = timePart.substring(0, 5);
      },

      renderEventScheduleRows(schedule = []) {
        const list = document.getElementById('eventScheduleList');
        if (!list) return;
        list.innerHTML = '';
        if (!Array.isArray(schedule) || schedule.length === 0) {
          list.innerHTML = '<div class="schedule-empty">Noch keine Programmpunkte.</div>';
          return;
        }
        schedule.forEach(slot => this.addEventScheduleRow(slot));
      },

      addEventScheduleRow(slot = {}) {
        const list = document.getElementById('eventScheduleList');
        if (!list) return;
        const empty = list.querySelector('.schedule-empty');
        if (empty) empty.remove();

        const date = this.escapeHtml((slot.date || '').toString());
        const start = this.escapeHtml((slot.start_time || '').toString());
        const end = this.escapeHtml((slot.end_time || '').toString());
        const label = this.escapeHtml((slot.label || '').toString());
        const timeText = this.escapeHtml((slot.time || '').toString());

        list.insertAdjacentHTML('beforeend', `
          <div class="schedule-row">
            <div class="schedule-row-grid">
              <input type="date" class="form-input schedule-date" value="${date}">
              <input type="time" class="form-input schedule-start" value="${start}">
              <input type="time" class="form-input schedule-end" value="${end}">
              <input type="text" class="form-input schedule-label" value="${label}" placeholder="Label (optional)">
            </div>
            <div class="schedule-row-grid" style="grid-template-columns: 1fr;">
              <input type="text" class="form-input schedule-time-text" value="${timeText}" placeholder="Alternative Zeitangabe (optional, z.B. Ganztägig)">
            </div>
            <div class="schedule-row-actions">
              <button type="button" class="btn btn-ghost btn-sm" onclick="App.removeEventScheduleRow(this)"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        `);
      },

      removeEventScheduleRow(button) {
        const row = button.closest('.schedule-row');
        if (!row) return;
        row.remove();
        const list = document.getElementById('eventScheduleList');
        if (list && list.querySelectorAll('.schedule-row').length === 0) {
          list.innerHTML = '<div class="schedule-empty">Noch keine Programmpunkte.</div>';
        }
      },

      collectEventScheduleRows() {
        const list = document.getElementById('eventScheduleList');
        if (!list) return [];
        const rows = Array.from(list.querySelectorAll('.schedule-row'));

        return rows
          .map((row) => {
            const date = (row.querySelector('.schedule-date')?.value || '').trim();
            const start = (row.querySelector('.schedule-start')?.value || '').trim();
            const end = (row.querySelector('.schedule-end')?.value || '').trim();
            const label = (row.querySelector('.schedule-label')?.value || '').trim();
            const timeText = (row.querySelector('.schedule-time-text')?.value || '').trim();

            if (!date && !label) return null;
            if (!start && !end && !timeText) return null;

            const slot = {};
            if (date) slot.date = date;
            if (label) slot.label = label;
            if (start) slot.start_time = start;
            if (end) slot.end_time = end;
            if (timeText) slot.time = timeText;
            return slot;
          })
          .filter(Boolean);
      },

      openEventImagePicker() {
        this.eventImageCallback = true;
        this.selectedImage = null;
        document.getElementById('imageModal').classList.add('active');
        this.loadImageGrid();
      },

      removeEventImage() {
        document.getElementById('eventImage').value = '';
        this.updateEventImagePreview('');
      },

      setEventIcon(btn) {
        document.querySelectorAll('#iconPicker .icon-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('eventIcon').value = btn.dataset.icon;
      },

      setEventColor(color) {
        document.getElementById('eventColor').value = color;
      },

      updateCategoryDefaults() {
        const cat = document.getElementById('eventCategory').value;
        const defaults = {
          gottesdienst: { color: '#10B981', icon: 'fa-church' },
          jugend: { color: '#8B5CF6', icon: 'fa-users' },
          special: { color: '#F59E0B', icon: 'fa-star' },
          gebet: { color: '#10B981', icon: 'fa-pray' },
          gemeinschaft: { color: '#F97316', icon: 'fa-heart' }
        };
        const d = defaults[cat] || { color: '#2563EB', icon: 'fa-calendar' };
        this.setEventColor(d.color);
        document.querySelectorAll('#iconPicker .icon-option').forEach(b => {
          b.classList.toggle('selected', b.dataset.icon === d.icon);
        });
        document.getElementById('eventIcon').value = d.icon;
      },

      closeEventModal() { document.getElementById('eventModal').classList.remove('active'); },
      editEvent(id) { const event = this.eventsData.items.find(e => e.id === id); if (event) this.openEventModal(event); },

      async saveEvent() {
        const id = document.getElementById('eventId').value || Date.now().toString();
        const flyerStyle = this.getCurrentFlyerStyle();
        const existing = this.eventsData.items.find(e => e.id === id) || {};
        const startDate = document.getElementById('eventDate').value;
        const startTime = document.getElementById('eventTime').value;
        const endDate = document.getElementById('eventEndDate').value;
        const endTime = document.getElementById('eventEndTime').value || startTime || '23:59';
        const schedule = this.collectEventScheduleRows();
        const event = {
          ...existing,
          id,
          title: document.getElementById('eventTitle').value,
          date: `${startDate}T${startTime}:00`,
          location: document.getElementById('eventLocation').value,
          category: document.getElementById('eventCategory').value,
          image: document.getElementById('eventImage').value,
          icon: document.getElementById('eventIcon').value,
          color: document.getElementById('eventColor').value,
          description: document.getElementById('eventDescription').value,
          featured: document.getElementById('eventFeatured').checked,
          published: document.getElementById('eventPublished').checked,
          flyerLayout: document.getElementById('eventFlyerLayout').checked,
          flyer_style: flyerStyle
        };
        if (endDate) {
          event.end_date = `${endDate}T${endTime}:00`;
          if (new Date(event.end_date) < new Date(event.date)) {
            this.toast('Enddatum darf nicht vor dem Startdatum liegen.', 'error');
            return;
          }
        } else {
          delete event.end_date;
        }
        if (schedule.length > 0) {
          event.schedule = schedule;
        } else {
          delete event.schedule;
        }
        const idx = this.eventsData.items.findIndex(e => e.id === id);
        if (idx >= 0) this.eventsData.items[idx] = event; else this.eventsData.items.push(event);
        try {
          await this.api('/data/events.json', { method: 'PUT', body: JSON.stringify(this.eventsData) });
          await this.api('/build', { method: 'POST' });
          this.closeEventModal();
          this.renderEventsTable();
          this.toast('Termin gespeichert!', 'success');
        } catch (err) {
          console.error('Save error:', err);
          this.toast('Fehler: ' + err.message, 'error');
        }
      },

      async deleteEvent() {
        const id = document.getElementById('eventId').value; if (!id || !confirm('Termin wirklich löschen?')) return;
        this.eventsData.items = this.eventsData.items.filter(e => e.id !== id);
        try { await this.api('/data/events.json', { method: 'PUT', body: JSON.stringify(this.eventsData) }); await this.api('/build', { method: 'POST' }); this.closeEventModal(); this.renderEventsTable(); this.toast('Termin gelöscht!', 'success'); }
        catch { this.toast('Fehler beim Löschen', 'error'); }
      },

      async loadMedia() {
        const container = document.getElementById('mediaContent');
        try {
          this.imagesData = await this.api('/images');
          if (this.imagesData.length === 0) container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-images"></i><h3>Keine Bilder</h3></div>';
          else container.innerHTML = `<div class="media-grid">${this.imagesData.map(img => {
            const url = typeof img === 'string' ? img : img.url;
            const name = typeof img === 'string' ? img.split('/').pop() : img.name;
            const safeName = this.escapeHtml(name);
            const safeUrlAttr = this.escapeHtml(url || '');
            const safeNameAttr = this.escapeHtml(name || '');
            return `<div class="media-item" onclick="App.copyMediaUrl(this)" data-url="${safeUrlAttr}" data-name="${safeNameAttr}"><img src="${this.SITE}${url}" alt="${safeName}"><div class="media-item-actions"><button type="button" class="media-delete-btn" title="Bild löschen" data-url="${safeUrlAttr}" data-name="${safeNameAttr}" onclick="event.stopPropagation(); App.deleteImageFromButton(this)"><i class="fa-solid fa-trash"></i></button></div><div class="media-item-overlay">${safeName}</div></div>`;
          }).join('')}</div>`;
        } catch { container.innerHTML = '<div class="empty-state"><p>Fehler</p></div>'; }
      },

      async deleteImage(url, name) {
        const label = name || (url || '').split('/').pop() || 'dieses Bild';
        if (!confirm(`Bild wirklich löschen?\n${label}`)) return;
        try {
          await this.api(`/images?url=${encodeURIComponent(url)}`, { method: 'DELETE' });
          if (this.selectedImage === url) this.selectedImage = null;
          await this.loadMedia();
          if (document.getElementById('imageModal').classList.contains('active')) {
            await this.loadImageGrid();
          }
          this.toast('Bild gelöscht!', 'success');
        } catch (err) {
          this.toast(`Löschen fehlgeschlagen: ${err.message}`, 'error');
        }
      },

      async uploadFiles(files) {
        for (const file of files) {
          const formData = new FormData(); formData.append('file', file);
          try { await fetch(`${this.API}/upload`, { method: 'POST', body: formData }); this.toast(`${file.name} hochgeladen!`, 'success'); }
          catch { this.toast(`Fehler bei ${file.name}`, 'error'); }
        }
        this.loadMedia(); document.getElementById('uploadInput').value = '';
      },

      copyToClipboard(text) { navigator.clipboard.writeText(text); this.toast('Pfad kopiert!', 'success'); },
      copyMediaUrl(el) {
        const text = (el && el.dataset && el.dataset.url) ? el.dataset.url : '';
        if (!text) return;
        this.copyToClipboard(text);
      },

      deleteImageFromButton(btn) {
        const row = btn ? btn.closest('.media-item') : null;
        const url = (btn && btn.dataset && btn.dataset.url) || (row && row.dataset && row.dataset.url) || '';
        const name = (btn && btn.dataset && btn.dataset.name) || (row && row.dataset && row.dataset.name) || '';
        if (!url) {
          this.toast('Bild-URL fehlt', 'error');
          return;
        }
        this.deleteImage(url, name);
      },

      openImagePicker(fieldKey) {
        this.imageFieldCallback = fieldKey; this.selectedImage = null;
        document.getElementById('imageModal').classList.add('active');
        this.loadImageGrid();
      },

      closeImageModal() { document.getElementById('imageModal').classList.remove('active'); this.imageFieldCallback = null; this.eventImageCallback = false; this.selectedImage = null; },

      async loadImageGrid() {
        const grid = document.getElementById('imageModalGrid');
        grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        try {
          const images = await this.api('/images');
          grid.innerHTML = images.map(img => {
            const url = typeof img === 'string' ? img : img.url;
            const name = typeof img === 'string' ? img.split('/').pop() : img.name;
            const safeUrlAttr = this.escapeHtml(url || '');
            const safeNameAttr = this.escapeHtml(name || '');
            return `<div class="media-item" onclick="App.selectImageItem(this)" data-url="${safeUrlAttr}" data-name="${safeNameAttr}"><img src="${this.SITE}${url}" alt="${this.escapeHtml(name || '')}"><div class="media-item-actions"><button type="button" class="media-delete-btn" title="Bild löschen" data-url="${safeUrlAttr}" data-name="${safeNameAttr}" onclick="event.stopPropagation(); App.deleteImageFromButton(this)"><i class="fa-solid fa-trash"></i></button></div></div>`;
          }).join('');
        } catch { grid.innerHTML = '<p>Fehler</p>'; }
      },

      selectImageItem(el, url) {
        const resolvedUrl = url || (el && el.dataset ? el.dataset.url : '');
        if (!resolvedUrl) return;
        document.querySelectorAll('#imageModalGrid .media-item').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected'); this.selectedImage = resolvedUrl;
      },

      selectImage() {
        if (!this.selectedImage) return;
        // Check if this is for event image or page editor
        if (this.eventImageCallback) {
          document.getElementById('eventImage').value = this.selectedImage;
          this.updateEventImagePreview(this.selectedImage);
          this.eventImageCallback = false;
        } else if (this.imageFieldCallback) {
          this.setValue(this.pageData, this.imageFieldCallback, this.selectedImage);
          this.hasChanges = true;
          this.updateEditorStatus();
          this.renderEditor();
        }
        this.closeImageModal();
      },

      removeImage(fieldKey) { this.setValue(this.pageData, fieldKey, ''); this.hasChanges = true; this.updateEditorStatus(); this.renderEditor(); },

      async uploadForModal(files) {
        for (const file of files) {
          const formData = new FormData(); formData.append('file', file);
          try { const result = await fetch(`${this.API}/upload`, { method: 'POST', body: formData }).then(r => r.json()); if (result.url) { this.selectedImage = result.url; this.toast('Hochgeladen!', 'success'); } }
          catch { this.toast('Fehler', 'error'); }
        }
        this.loadImageGrid(); document.getElementById('modalUploadInput').value = '';
      },

      async loadSettings() {
        const container = document.getElementById('settingsContent');
        try { this.settingsData = await this.api('/data/settings.json'); } catch { this.settingsData = {}; }
        if (!this.settingsData.contact) this.settingsData.contact = {};
        if (!this.settingsData.social_media) this.settingsData.social_media = {};
        if (!this.settingsData.footer) this.settingsData.footer = {};
        if (!this.settingsData.service_times) this.settingsData.service_times = {};
        if (!this.settingsData.service_times.main_service) this.settingsData.service_times.main_service = {};
        const esc = (value) => this.escapeHtml(value || '');
        const showSocialChecked = this.settingsData.footer.show_social_icons !== false ? 'checked' : '';
        container.innerHTML = `
          <div class="card"><div class="card-header"><h3 class="card-title">Website</h3></div><div class="card-body">
            <div class="form-group"><label class="form-label">Seitentitel</label><input type="text" class="form-input" id="set_site_title" value="${esc(this.settingsData.site_title)}"></div>
            <div class="form-group"><label class="form-label">Seitenbeschreibung (SEO)</label><textarea class="form-textarea" id="set_site_description">${esc(this.settingsData.site_description)}</textarea></div>
          </div></div>
          <div class="card"><div class="card-header"><h3 class="card-title">Kontakt & Adresse</h3></div><div class="card-body">
            <div class="form-group"><label class="form-label">E-Mail</label><input type="email" class="form-input" id="set_email" value="${esc(this.settingsData.contact.email)}"></div>
            <div class="form-group"><label class="form-label">Telefon</label><input type="text" class="form-input" id="set_phone" value="${esc(this.settingsData.contact.phone)}"></div>
            <div class="form-group"><label class="form-label">WhatsApp</label><input type="text" class="form-input" id="set_whatsapp" value="${esc(this.settingsData.contact.whatsapp)}" placeholder="+49... oder 49..."></div>
            <div class="form-group"><label class="form-label">Adresse</label><input type="text" class="form-input" id="set_address" value="${esc(this.settingsData.contact.address)}"></div>
            <div class="form-group"><label class="form-label">Stadt</label><input type="text" class="form-input" id="set_city" value="${esc(this.settingsData.contact.city)}"></div>
            <div class="form-group"><label class="form-label">Land</label><input type="text" class="form-input" id="set_country" value="${esc(this.settingsData.contact.country)}"></div>
            <div class="form-group"><label class="form-label">Google Maps URL</label><input type="text" class="form-input" id="set_maps_url" value="${esc(this.settingsData.contact.maps_url)}"></div>
          </div></div>
          <div class="card"><div class="card-header"><h3 class="card-title">Social Media</h3></div><div class="card-body">
            <div class="form-group"><label class="form-label">Instagram</label><input type="text" class="form-input" id="set_instagram" value="${esc(this.settingsData.social_media.instagram)}"></div>
            <div class="form-group"><label class="form-label">Facebook</label><input type="text" class="form-input" id="set_facebook" value="${esc(this.settingsData.social_media.facebook)}"></div>
            <div class="form-group"><label class="form-label">YouTube</label><input type="text" class="form-input" id="set_youtube" value="${esc(this.settingsData.social_media.youtube)}"></div>
            <div class="form-group"><label class="form-label">TikTok</label><input type="text" class="form-input" id="set_tiktok" value="${esc(this.settingsData.social_media.tiktok)}"></div>
          </div></div>
          <div class="card"><div class="card-header"><h3 class="card-title">Footer & Gottesdienst</h3></div><div class="card-body">
            <div class="form-group"><label class="form-label">Copyright</label><input type="text" class="form-input" id="set_footer_copyright" value="${esc(this.settingsData.footer.copyright_text)}"></div>
            <div class="form-group"><div class="toggle-wrapper"><label class="toggle"><input type="checkbox" id="set_show_social_icons" ${showSocialChecked}><span class="toggle-slider"></span></label><span class="toggle-label">Social Icons im Footer anzeigen</span></div></div>
            <div class="form-group"><label class="form-label">Hauptgottesdienst: Tag</label><input type="text" class="form-input" id="set_main_service_day" value="${esc(this.settingsData.service_times.main_service.day)}"></div>
            <div class="form-group"><label class="form-label">Hauptgottesdienst: Uhrzeit</label><input type="text" class="form-input" id="set_main_service_time" value="${esc(this.settingsData.service_times.main_service.time)}"></div>
            <div class="form-group"><label class="form-label">Hauptgottesdienst: Beschreibung</label><input type="text" class="form-input" id="set_main_service_description" value="${esc(this.settingsData.service_times.main_service.description)}"></div>
          </div></div>`;
      },

      async saveSettings(shouldBuild = false) {
        this.settingsData.site_title = document.getElementById('set_site_title').value;
        this.settingsData.site_description = document.getElementById('set_site_description').value;
        if (!this.settingsData.contact) this.settingsData.contact = {};
        if (!this.settingsData.social_media) this.settingsData.social_media = {};
        if (!this.settingsData.footer) this.settingsData.footer = {};
        if (!this.settingsData.service_times) this.settingsData.service_times = {};
        if (!this.settingsData.service_times.main_service) this.settingsData.service_times.main_service = {};
        this.settingsData.contact.email = document.getElementById('set_email').value;
        this.settingsData.contact.phone = document.getElementById('set_phone').value;
        this.settingsData.contact.whatsapp = document.getElementById('set_whatsapp').value;
        this.settingsData.contact.address = document.getElementById('set_address').value;
        this.settingsData.contact.city = document.getElementById('set_city').value;
        this.settingsData.contact.country = document.getElementById('set_country').value;
        this.settingsData.contact.maps_url = document.getElementById('set_maps_url').value;
        this.settingsData.social_media.instagram = this.normalizeSocialUrl(document.getElementById('set_instagram').value, 'instagram');
        this.settingsData.social_media.facebook = this.normalizeSocialUrl(document.getElementById('set_facebook').value, 'facebook');
        this.settingsData.social_media.youtube = this.normalizeSocialUrl(document.getElementById('set_youtube').value, 'youtube');
        this.settingsData.social_media.tiktok = this.normalizeSocialUrl(document.getElementById('set_tiktok').value, 'tiktok');
        delete this.settingsData.social_media.twitter;
        this.settingsData.footer.copyright_text = document.getElementById('set_footer_copyright').value;
        this.settingsData.footer.show_social_icons = document.getElementById('set_show_social_icons').checked;
        this.settingsData.service_times.main_service.day = document.getElementById('set_main_service_day').value;
        this.settingsData.service_times.main_service.time = document.getElementById('set_main_service_time').value;
        this.settingsData.service_times.main_service.description = document.getElementById('set_main_service_description').value;
        try {
          await this.api('/data/settings.json', { method: 'PUT', body: JSON.stringify(this.settingsData) });
          if (shouldBuild) {
            await this.api('/build', { method: 'POST' });
            this.toast('Einstellungen veröffentlicht!', 'success');
          } else {
            this.toast('Einstellungen gespeichert!', 'success');
          }
        }
        catch (err) { console.error('Save error:', err); this.toast('Fehler: ' + err.message, 'error'); }
      },

      normalizeSocialUrl(value, platform) {
        const raw = (value || '').trim();
        if (!raw) return '';
        if (/^(https?:)?\/\//i.test(raw)) return raw.startsWith('//') ? `https:${raw}` : raw;

        const cleaned = raw.replace(/^@/, '');
        const hostByPlatform = {
          instagram: 'instagram.com',
          facebook: 'facebook.com',
          youtube: 'youtube.com',
          tiktok: 'tiktok.com'
        };
        const host = hostByPlatform[platform] || '';
        if (!host) return cleaned;

        if (cleaned.includes('/')) return `https://${cleaned}`;
        return `https://${host}/${cleaned}`;
      },

      async saveSettingsAndBuild() { await this.saveSettings(true); },

      getValue(obj, path) {
        return path.split('.').reduce((o, k) => {
          if (o === null || o === undefined) return undefined;
          // Handle array indices
          const idx = parseInt(k, 10);
          if (!isNaN(idx) && Array.isArray(o)) return o[idx];
          return o[k];
        }, obj);
      },
      setValue(obj, path, value) {
        const keys = path.split('.');
        const last = keys.pop();
        const target = keys.reduce((o, k) => {
          const idx = parseInt(k, 10);
          const nextKey = keys[keys.indexOf(k) + 1];
          const nextIsArray = !isNaN(parseInt(nextKey, 10));
          if (!isNaN(idx)) {
            // Current key is array index
            if (!Array.isArray(o)) return o;
            if (!o[idx]) o[idx] = nextIsArray ? [] : {};
            return o[idx];
          }
          // Current key is object key
          if (!o[k]) o[k] = nextIsArray ? [] : {};
          return o[k];
        }, obj);
        const lastIdx = parseInt(last, 10);
        if (!isNaN(lastIdx) && Array.isArray(target)) target[lastIdx] = value;
        else target[last] = value;
      },
      escapeHtml(str) { const div = document.createElement('div'); div.textContent = str || ''; return div.innerHTML; }
    };

    App.init();
  </script>
</body>
</html>
