<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Newness of Life</title>
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/index.css">
</head>
<body>
  <!-- Preview Bar -->
  <div class="preview-bar">
    <h1>Newness of Life - Admin</h1>
    <div class="buttons">
      <button class="btn-preview" onclick="togglePreview()" id="preview-toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        Vorschau
      </button>
      <button class="btn-refresh" onclick="refreshPreview()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        Aktualisieren
      </button>
      <button class="btn-site" onclick="openSite()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
          <polyline points="15 3 21 3 21 9"/>
          <line x1="10" y1="14" x2="21" y2="3"/>
        </svg>
        Neues Fenster
      </button>
      <button class="btn-back" onclick="goBackPage()" id="page-back" disabled>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
        Zurueck
      </button>
      <div class="page-select">
        <span>Seite</span>
        <select id="page-select">
          <option value="index.html">Startseite</option>
          <option value="ueber-uns.html">Ueber uns</option>
          <option value="gottesdienste.html">Gottesdienste</option>
          <option value="veranstaltungen.html">Veranstaltungen</option>
          <option value="spenden.html">Spenden</option>
          <option value="datenschutz.html">Datenschutz</option>
          <option value="impressum.html">Impressum</option>
        </select>
      </div>
      <span class="help-text">Tipp: watch.js baut automatisch nach dem Speichern</span>
    </div>
    <span class="status online" id="status">Lokal verbunden</span>
  </div>

  <!-- Main Layout -->
  <div class="admin-layout">
    <!-- CMS Panel -->
    <div class="cms-panel" id="cms-panel">
      <!-- Decap CMS loads here -->
      <div id="nc-root"></div>
    </div>

    <!-- Preview Panel -->
    <div class="preview-panel" id="preview-panel">
      <div class="preview-header">
        <h3>Live-Vorschau</h3>
        <div class="preview-controls">
          <button class="device-btn active" onclick="setDevice('desktop')" title="Desktop">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
              <line x1="8" y1="21" x2="16" y2="21"/>
              <line x1="12" y1="17" x2="12" y2="21"/>
            </svg>
          </button>
          <button class="device-btn" onclick="setDevice('tablet')" title="Tablet">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
              <line x1="12" y1="18" x2="12" y2="18"/>
            </svg>
          </button>
          <button class="device-btn" onclick="setDevice('mobile')" title="Mobil">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
              <line x1="12" y1="18" x2="12" y2="18"/>
            </svg>
          </button>
          <button onclick="closePreview()">Schliessen</button>
        </div>
      </div>
      <div class="preview-iframe-container">
        <div class="preview-iframe-wrapper" id="iframe-wrapper">
          <iframe id="preview-iframe" src="about:blank"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <script>
    let previewVisible = true;
    let currentDevice = 'desktop';
    let currentPage = 'index.html';
    const pageHistory = [];
    const SITE_URL = 'http://localhost:8080';

    // Toggle Preview Panel
    function togglePreview() {
      previewVisible = !previewVisible;
      const previewPanel = document.getElementById('preview-panel');
      const cmsPanel = document.getElementById('cms-panel');
      const toggleBtn = document.getElementById('preview-toggle');

      if (previewVisible) {
        previewPanel.classList.remove('hidden');
        cmsPanel.classList.add('with-preview');
        toggleBtn.classList.add('active');
        loadPreview();
      } else {
        previewPanel.classList.add('hidden');
        cmsPanel.classList.remove('with-preview');
        toggleBtn.classList.remove('active');
      }
    }

    // Close Preview
    function closePreview() {
      previewVisible = false;
      document.getElementById('preview-panel').classList.add('hidden');
      document.getElementById('cms-panel').classList.remove('with-preview');
      document.getElementById('preview-toggle').classList.remove('active');
    }

    // Load Preview
    function loadPreview() {
      const iframe = document.getElementById('preview-iframe');
      const base = SITE_URL.replace(/\/$/, '');
      const url = new URL(base + '/' + currentPage);
      url.searchParams.set('cms-preview', '1');
      url.searchParams.set('t', Date.now().toString());
      iframe.src = url.toString();
    }

    // Refresh Preview
    function refreshPreview() {
      if (previewVisible) {
        loadPreview();
      } else {
        togglePreview();
      }
    }

    // Set Device Size
    function setDevice(device) {
      currentDevice = device;
      const wrapper = document.getElementById('iframe-wrapper');
      const buttons = document.querySelectorAll('.device-btn');

      wrapper.classList.remove('mobile', 'tablet', 'desktop');
      if (device !== 'desktop') {
        wrapper.classList.add(device);
      }

      buttons.forEach((btn, index) => {
        btn.classList.remove('active');
        if ((device === 'desktop' && index === 0) ||
            (device === 'tablet' && index === 1) ||
            (device === 'mobile' && index === 2)) {
          btn.classList.add('active');
        }
      });
    }

    // Open Site in new window
    function openSite() {
      const base = SITE_URL.replace(/\/$/, '');
      window.open(base + '/' + currentPage, '_blank');
    }

    // Page Selector
    const pageSelect = document.getElementById('page-select');
    const pageBack = document.getElementById('page-back');
    if (pageSelect) {
      pageSelect.value = currentPage;
      pageSelect.addEventListener('change', function() {
        setPage(pageSelect.value, true);
      });
    }
    if (pageBack) {
      pageBack.addEventListener('click', function() {
        goBackPage();
      });
    }

    function setPage(nextPage, pushHistory) {
      if (!nextPage || nextPage === currentPage) return;
      if (pushHistory) {
        pageHistory.push(currentPage);
      }
      currentPage = nextPage;
      if (pageSelect) {
        pageSelect.value = currentPage;
      }
      updateBackButton();
      if (previewVisible) {
        loadPreview();
      }
    }

    function goBackPage() {
      if (!pageHistory.length) return;
      const previous = pageHistory.pop();
      setPage(previous, false);
    }

    function updateBackButton() {
      if (!pageBack) return;
      pageBack.disabled = pageHistory.length === 0;
    }

    // Click-to-Edit: focus CMS field from preview
    let activeField = null;
    let activeInput = null;
    let activeInputHandler = null;

    function normalizeText(text) {
      return (text || '').replace(/\s+/g, ' ').trim().toLowerCase();
    }

    function findFieldInputByLabel(label) {
      if (!label) return null;
      const labels = Array.from(document.querySelectorAll('label, [data-testid="control-label"], .nc-fieldLabel'));
      const match = labels.find(el => normalizeText(el.textContent) === normalizeText(label));
      if (!match) return null;

      const fieldRoot = match.closest('.nc-field, .field, [data-testid="field"], .nc-Field') || match.parentElement;
      if (!fieldRoot) return null;
      return fieldRoot.querySelector('input, textarea, select, [contenteditable="true"]');
    }

    function findFieldInputByName(field) {
      if (!field) return null;
      const candidates = Array.from(document.querySelectorAll('input[name], textarea[name], select[name]'));
      const exact = candidates.find(el => el.name === field);
      if (exact) return exact;
      const fieldLeaf = field.split('.').pop();
      const leafMatches = candidates.filter(el => el.name === fieldLeaf);
      if (leafMatches.length === 1) return leafMatches[0];
      return null;
    }

    function focusCmsField(field, label) {
      let input = findFieldInputByName(field);
      if (!input) {
        input = findFieldInputByLabel(label);
      }
      if (!input) return false;

      input.focus();
      input.scrollIntoView({ behavior: 'smooth', block: 'center' });
      attachLiveSync(input, field);
      return true;
    }

    function attachLiveSync(input, field) {
      if (!input || !field) return;
      if (activeInput && activeInputHandler) {
        activeInput.removeEventListener('input', activeInputHandler);
        activeInput.removeEventListener('change', activeInputHandler);
      }

      activeField = field;
      activeInput = input;
      activeInputHandler = function(event) {
        const value = event.target.type === 'checkbox' ? event.target.checked : event.target.value;
        const iframe = document.getElementById('preview-iframe');
        if (!iframe || !iframe.contentWindow) return;
        iframe.contentWindow.postMessage({
          type: 'cms-update-field',
          field: activeField,
          value: value
        }, '*');
      };

      input.addEventListener('input', activeInputHandler);
      input.addEventListener('change', activeInputHandler);
    }

    window.addEventListener('message', function(event) {
      if (!event.data) return;

      // Click-to-Edit: Feld auswaehlen
      if (event.data.type === 'cms-select-field') {
        const field = event.data.field;
        const label = event.data.label;
        const found = focusCmsField(field, label);
        const status = document.getElementById('status');
        if (found) {
          status.textContent = 'Feld ausgewaehlt: ' + (label || field);
          status.classList.add('online');
          status.classList.remove('building');
        } else {
          status.textContent = 'Feld nicht im Editor';
          status.classList.remove('online');
        }
        return;
      }

      // Navigation innerhalb der Vorschau
      if (event.data.type === 'cms-navigate') {
        const page = event.data.page;
        if (page) {
          setPage(page, true);
        }
        return;
      }
    });

    // Initial preview state
    document.getElementById('preview-panel').classList.remove('hidden');
    document.getElementById('cms-panel').classList.add('with-preview');
    document.getElementById('preview-toggle').classList.add('active');
    loadPreview();

    // Auto-refresh preview when CMS saves
    if (window.CMS) {
      CMS.registerEventListener({
        name: 'postSave',
        handler: function() {
          // Wait for watch.js to rebuild
          document.getElementById('status').textContent = 'Wird neu gebaut...';
          document.getElementById('status').classList.remove('online');
          document.getElementById('status').classList.add('building');

          setTimeout(function() {
            if (previewVisible) {
              loadPreview();
            }
            document.getElementById('status').textContent = 'Lokal verbunden';
            document.getElementById('status').classList.remove('building');
            document.getElementById('status').classList.add('online');
          }, 2000);
        }
      });
    }

    // Fehler abfangen
    window.onerror = function(msg, url, line) {
      console.error('CMS Error:', msg);
      return false;
    };
  </script>
</body>
</html>
