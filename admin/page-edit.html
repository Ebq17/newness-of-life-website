<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seite bearbeiten - Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/page-edit.css">
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="pages.html" class="back-link">
        <i class="fas fa-chevron-left"></i>
        Zurück
      </a>
      <h1 class="header-title" id="pageTitle">Seite bearbeiten</h1>
    </div>
    <div class="header-actions">
      <div class="status-badge draft" id="statusBadge">
        <span class="status-dot"></span>
        <span id="statusText">Entwurf</span>
      </div>
      <button class="btn btn-secondary" id="saveBtn" onclick="saveData(false)">
        <i class="fas fa-save"></i>
        Speichern
      </button>
      <button class="btn btn-success" onclick="confirmPublish()">
        <i class="fas fa-check"></i>
        Veröffentlichen
      </button>
    </div>
  </header>

  <div class="split-view">
    <!-- Preview Panel -->
    <div class="preview-panel">
      <div class="preview-header">
        <div class="preview-dots"><span></span><span></span><span></span></div>
        <div class="preview-url" id="previewUrl">-</div>
        <div class="viewport-switcher">
          <button class="viewport-btn active" data-viewport="desktop" title="Desktop">
            <i class="fas fa-desktop"></i>
          </button>
          <button class="viewport-btn" data-viewport="tablet" title="Tablet">
            <i class="fas fa-tablet-alt"></i>
          </button>
          <button class="viewport-btn" data-viewport="mobile" title="Mobile">
            <i class="fas fa-mobile-alt"></i>
          </button>
        </div>
        <div class="preview-actions">
          <button onclick="refreshPreview()" title="Aktualisieren">
            <i class="fas fa-sync-alt"></i>
          </button>
          <button onclick="openInNewWindow()" title="In neuem Fenster">
            <i class="fas fa-external-link-alt"></i>
          </button>
        </div>
      </div>
      <div class="preview-iframe-container">
        <div class="preview-iframe-wrapper desktop" id="previewFrame">
          <div class="edit-mode-indicator">
            <span class="dot"></span>
            <span>Bearbeiten</span>
          </div>
          <iframe id="previewIframe" src=""></iframe>
        </div>
      </div>
    </div>

    <!-- Editor Panel -->
    <div class="editor-panel">
      <div class="editor-header">
        <h2 id="editorTitle">Startseite</h2>
        <p>Klicke auf ein Element in der Vorschau oder bearbeite hier</p>
      </div>

      <!-- Editor Tabs -->
      <div class="editor-tabs">
        <button class="editor-tab active" data-tab="content" onclick="switchTab('content')">
          <i class="fas fa-edit"></i> Inhalt
        </button>
        <button class="editor-tab" data-tab="blocks" onclick="switchTab('blocks')">
          <i class="fas fa-th-large"></i> Blöcke
        </button>
        <button class="editor-tab" data-tab="seo" onclick="switchTab('seo')">
          <i class="fas fa-search"></i> SEO
        </button>
      </div>

      <!-- Content Tab -->
      <div class="tab-content active" id="tab-content">
        <div class="tab-pane" id="contentPane">
          <div class="loading">
            <div class="spinner"></div>
            Lade Daten...
          </div>
        </div>
      </div>

      <!-- Blocks Tab -->
      <div class="tab-content" id="tab-blocks">
        <div class="tab-pane">
          <p class="form-hint mb-16">Aktiviere oder deaktiviere Seitenabschnitte.</p>
          <div id="blockList">
            <!-- Blocks rendered here -->
          </div>
        </div>
      </div>

      <!-- SEO Tab -->
      <div class="tab-content" id="tab-seo">
        <div class="tab-pane">
          <div class="form-group">
            <label class="form-label"><i class="fas fa-heading"></i> Seitentitel</label>
            <input type="text" class="form-input" id="metaTitle" placeholder="Titel für Browser-Tab und Google" oninput="updateSeo('meta_title', this.value)">
            <div class="char-count"><span id="metaTitleCount">0</span>/60 Zeichen</div>
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-align-left"></i> Meta-Beschreibung</label>
            <textarea class="form-textarea" id="metaDesc" placeholder="Kurze Beschreibung für Google-Suchergebnisse" oninput="updateSeo('meta_description', this.value)"></textarea>
            <div class="char-count"><span id="metaDescCount">0</span>/160 Zeichen</div>
          </div>
        </div>
      </div>

      <div class="save-status-bar">
        <div class="last-saved">
          <i class="fas fa-clock"></i>
          <span id="lastSavedText">Noch nicht gespeichert</span>
        </div>
        <span>Ctrl+S zum Speichern</span>
      </div>
    </div>
  </div>

  <!-- Media Picker Modal -->
  <div class="modal-overlay" id="mediaModal">
    <div class="modal">
      <h3>Medien auswählen</h3>
      <div class="form-group">
        <input type="file" id="mediaFileInput" class="is-hidden" accept="image/*" onchange="handleFileUpload(this)">
        <button class="btn btn-primary w-100" onclick="document.getElementById('mediaFileInput').click()">
          <i class="fas fa-upload"></i> Datei hochladen
        </button>
      </div>
      <p class="modal-hint">oder aus Galerie wählen:</p>
      <div class="image-gallery" id="imageGallery">
        <!-- Images loaded here -->
      </div>
      <div class="modal-actions mt-16">
        <button class="btn btn-secondary" onclick="closeMediaModal()">Abbrechen</button>
        <button class="btn btn-primary" onclick="selectMedia()">Auswählen</button>
      </div>
    </div>
  </div>

  <!-- Publish Modal -->
  <div class="modal-overlay" id="publishModal">
    <div class="modal">
      <h3>Änderungen veröffentlichen?</h3>
      <p>Die Änderungen werden für alle Besucher sichtbar. Bist du sicher?</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closePublishModal()">Abbrechen</button>
        <button class="btn btn-success" onclick="publishChanges()">Ja, veröffentlichen</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    const API_URL = new URL('/api', window.location.origin).toString().replace(/\/$/, '');
    const PREVIEW_URL = window.location.origin;

    // State
    let currentPage = null;
    let currentData = {};
    let hasUnsavedChanges = false;
    let iframeReady = false;
    let pendingUpdates = [];
    let mediaPickerContext = { mode: 'data', path: null };
    let selectedMediaUrl = null;
    const imageHistory = {};

    // Page config
    const pageConfigs = {
      homepage: {
        title: 'Startseite',
        dataFile: 'homepage.json',
        previewUrl: '/index.html',
        sections: [
          {
            id: 'hero',
            title: 'Hero-Bereich',
            icon: 'fas fa-star',
            enabled: true,
            fields: [
              { path: 'hero.title', label: 'Haupttitel', type: 'text', placeholder: 'Willkommen...' },
              { path: 'hero.subtitle', label: 'Untertitel', type: 'textarea', placeholder: 'Beschreibung...' },
              { path: 'hero.background_image', label: 'Hintergrundbild', type: 'image' },
              { path: 'hero.cta_text', label: 'Button Text', type: 'text', placeholder: 'Mehr erfahren' },
              { path: 'hero.cta_link', label: 'Button Link', type: 'text', placeholder: 'ueber-uns.html' }
            ]
          },
          {
            id: 'services',
            title: 'Gottesdienste',
            icon: 'fas fa-church',
            enabled: true,
            fields: [
              { path: 'services_section.title', label: 'Titel', type: 'text' },
              { path: 'services_section.description', label: 'Beschreibung', type: 'textarea' },
              { path: 'services_section.service_day', label: 'Tag', type: 'text' },
              { path: 'services_section.service_time', label: 'Uhrzeit', type: 'text' },
              { path: 'services_section.kids_info', label: 'Kinderinfo', type: 'text' }
            ]
          },
          {
            id: 'about',
            title: 'Über uns',
            icon: 'fas fa-users',
            enabled: true,
            fields: [
              { path: 'about_section.title', label: 'Titel', type: 'text' },
              { path: 'about_section.subtitle', label: 'Untertitel', type: 'text' },
              { path: 'about_section.text', label: 'Text', type: 'textarea' }
            ]
          },
          {
            id: 'contact',
            title: 'Kontakt',
            icon: 'fas fa-envelope',
            enabled: true,
            fields: [
              { path: 'contact_section.title', label: 'Titel', type: 'text' },
              { path: 'contact_section.form_title', label: 'Formular Titel', type: 'text' },
              { path: 'contact_section.address_title', label: 'Adresse Titel', type: 'text' }
            ]
          }
        ]
      },
      gottesdienste: {
        title: 'Gottesdienste',
        dataFile: 'gottesdienste.json',
        previewUrl: '/gottesdienste.html',
        sections: [
          {
            id: 'hero',
            title: 'Hero-Bereich',
            icon: 'fas fa-church',
            enabled: true,
            fields: [
              { path: 'hero.title', label: 'Titel', type: 'text' },
              { path: 'hero.subtitle', label: 'Untertitel', type: 'textarea' },
              { path: 'hero.background_image', label: 'Hintergrundbild', type: 'image' }
            ]
          },
          {
            id: 'intro',
            title: 'Intro',
            icon: 'fas fa-info-circle',
            enabled: true,
            fields: [
              { path: 'intro.title', label: 'Titel', type: 'text' },
              { path: 'intro.text', label: 'Text', type: 'textarea' }
            ]
          },
          {
            id: 'main_service',
            title: 'Hauptgottesdienst',
            icon: 'fas fa-clock',
            enabled: true,
            fields: [
              { path: 'main_service.title', label: 'Titel', type: 'text' },
              { path: 'main_service.day', label: 'Tag', type: 'text' },
              { path: 'main_service.time', label: 'Uhrzeit', type: 'text' },
              { path: 'main_service.duration', label: 'Dauer', type: 'text' },
              { path: 'main_service.description', label: 'Beschreibung', type: 'textarea' },
              {
                path: 'main_service.features',
                label: 'Features (Kacheln)',
                type: 'list',
                itemLabelKey: 'title',
                itemTemplate: { title: '', description: '', icon: 'fa-star' },
                fields: [
                  { key: 'title', label: 'Titel', type: 'text' },
                  { key: 'description', label: 'Beschreibung', type: 'text' },
                  { key: 'icon', label: 'Icon (FontAwesome)', type: 'text' }
                ]
              }
            ]
          },
          {
            id: 'other_meetings',
            title: 'Weitere Treffen',
            icon: 'fas fa-users',
            enabled: true,
            fields: [
              { path: 'other_meetings.title', label: 'Titel', type: 'text' },
              {
                path: 'other_meetings.items',
                label: 'Treffen',
                type: 'list',
                itemLabelKey: 'title',
                itemTemplate: { title: '', day: '', time: '', description: '', icon: 'fa-calendar' },
                fields: [
                  { key: 'title', label: 'Titel', type: 'text' },
                  { key: 'day', label: 'Tag', type: 'text' },
                  { key: 'time', label: 'Uhrzeit', type: 'text' },
                  { key: 'description', label: 'Beschreibung', type: 'text' },
                  { key: 'icon', label: 'Icon (FontAwesome)', type: 'text' }
                ]
              }
            ]
          },
          {
            id: 'cta',
            title: 'CTA (Einladung)',
            icon: 'fas fa-bullhorn',
            enabled: true,
            fields: [
              { path: 'cta.title', label: 'Titel', type: 'text' },
              { path: 'cta.text', label: 'Text', type: 'textarea' },
              { path: 'cta.button_text', label: 'Button Text', type: 'text' },
              { path: 'cta.button_link', label: 'Button Link', type: 'text' }
            ]
          },
          {
            id: 'anfahrt',
            title: 'Anfahrt',
            icon: 'fas fa-map-marked-alt',
            enabled: true,
            fields: [
              { path: 'anfahrt.title', label: 'Titel', type: 'text' },
              { path: 'anfahrt.text', label: 'Text', type: 'textarea', placeholder: 'Optional – leer lassen für Standard-Adresse aus Einstellungen.' }
            ]
          }
        ]
      },
      'ueber-uns': {
        title: 'Über uns',
        dataFile: 'ueber-uns.json',
        previewUrl: '/ueber-uns.html',
        sections: [
          {
            id: 'hero',
            title: 'Hero-Bereich',
            icon: 'fas fa-user-friends',
            enabled: true,
            fields: [
              { path: 'hero.title', label: 'Titel', type: 'text' },
              { path: 'hero.subtitle', label: 'Untertitel', type: 'textarea' },
              { path: 'hero.background_image', label: 'Hintergrundbild', type: 'image' }
            ]
          },
          {
            id: 'intro',
            title: 'Intro',
            icon: 'fas fa-info-circle',
            enabled: true,
            fields: [
              { path: 'intro.title', label: 'Titel', type: 'text' },
              { path: 'intro.text', label: 'Text', type: 'textarea' }
            ]
          },
          {
            id: 'story',
            title: 'Geschichte',
            icon: 'fas fa-book-open',
            enabled: true,
            fields: [
              { path: 'story.title', label: 'Titel', type: 'text' },
              { path: 'story.text', label: 'Text', type: 'textarea' },
              { path: 'story.image', label: 'Bild', type: 'image' }
            ]
          },
          {
            id: 'vision',
            title: 'Vision',
            icon: 'fas fa-bullseye',
            enabled: true,
            fields: [
              { path: 'vision.title', label: 'Titel', type: 'text' },
              { path: 'vision.text', label: 'Text', type: 'textarea' }
            ]
          }
        ]
      },
      spenden: {
        title: 'Spenden',
        dataFile: 'spenden.json',
        previewUrl: '/spenden.html',
        sections: [
          {
            id: 'hero',
            title: 'Hero-Bereich',
            icon: 'fas fa-heart',
            enabled: true,
            fields: [
              { path: 'hero.title', label: 'Titel', type: 'text' },
              { path: 'hero.subtitle', label: 'Untertitel', type: 'textarea' },
              { path: 'hero.background_image', label: 'Hintergrundbild', type: 'image' }
            ]
          },
          {
            id: 'impact',
            title: 'Impact',
            icon: 'fas fa-hands-helping',
            enabled: true,
            fields: [
              { path: 'impact.title', label: 'Titel', type: 'text' }
            ]
          },
          {
            id: 'bank_details',
            title: 'Bankverbindung',
            icon: 'fas fa-university',
            enabled: true,
            fields: [
              { path: 'bank_details.title', label: 'Titel', type: 'text' },
              { path: 'bank_details.account_holder', label: 'Kontoinhaber', type: 'text' },
              { path: 'bank_details.iban', label: 'IBAN', type: 'text' },
              { path: 'bank_details.bic', label: 'BIC', type: 'text' },
              { path: 'bank_details.bank_name', label: 'Bank', type: 'text' },
              { path: 'bank_details.reference', label: 'Verwendungszweck', type: 'text' }
            ]
          }
        ]
      },
      datenschutz: {
        title: 'Datenschutz',
        dataFile: 'datenschutz.json',
        previewUrl: '/datenschutz.html',
        sections: [
          {
            id: 'hero',
            title: 'Header',
            icon: 'fas fa-shield-alt',
            enabled: true,
            fields: [
              { path: 'hero.title', label: 'Titel', type: 'text' },
              { path: 'hero.subtitle', label: 'Untertitel', type: 'textarea' },
              { path: 'hero.background_image', label: 'Header Bild', type: 'image' }
            ]
          }
        ]
      },
      impressum: {
        title: 'Impressum',
        dataFile: 'impressum.json',
        previewUrl: '/impressum.html',
        sections: [
          {
            id: 'hero',
            title: 'Header',
            icon: 'fas fa-file-alt',
            enabled: true,
            fields: [
              { path: 'hero.title', label: 'Titel', type: 'text' },
              { path: 'hero.subtitle', label: 'Untertitel', type: 'textarea' },
              { path: 'hero.background_image', label: 'Header Bild', type: 'image' }
            ]
          }
        ]
      },
      global: {
        title: 'Global',
        dataFile: 'global.json',
        previewUrl: '/index.html',
        sections: [
          {
            id: 'header',
            title: 'Header / Logo',
            icon: 'fas fa-flag',
            enabled: true,
            fields: [
              { path: 'header.logo.image', label: 'Logo Bild', type: 'image' },
              { path: 'header.logo.alt', label: 'Alt-Text', type: 'text' },
              { path: 'header.logo.text', label: 'Logo Text', type: 'text' },
              { path: 'header.logo.subtext', label: 'Untertitel', type: 'text' }
            ]
          },
          {
            id: 'service_cards',
            title: 'Service-Karten (Startseite)',
            icon: 'fas fa-clone',
            enabled: true,
            fields: [
              {
                path: 'service_cards',
                label: 'Karten',
                type: 'list',
                itemLabelKey: 'title',
                itemTemplate: {
                  label: '',
                  title: '',
                  time: '',
                  image: '',
                  link: '',
                  show: true
                },
                fields: [
                  { key: 'label', label: 'Kategorie', type: 'text' },
                  { key: 'title', label: 'Titel', type: 'text' },
                  { key: 'time', label: 'Zeit/Beschreibung', type: 'text' },
                  { key: 'image', label: 'Bild', type: 'image' },
                  { key: 'link', label: 'Link', type: 'text' },
                  { key: 'show', label: 'Anzeigen', type: 'checkbox' }
                ]
              }
            ]
          },
          {
            id: 'footer',
            title: 'Footer',
            icon: 'fas fa-shoe-prints',
            enabled: true,
            fields: [
              { path: 'footer.about_text', label: 'Über uns Text', type: 'textarea' },
              { path: 'footer.donation_text', label: 'Spenden Text', type: 'text' },
              { path: 'footer.copyright', label: 'Copyright', type: 'text' }
            ]
          }
        ]
      }
    };

    // Get page from URL
    const urlParams = new URLSearchParams(window.location.search);
    const pageSlug = urlParams.get('page') || 'homepage';

    // Tab switching
    function switchTab(tabId) {
      document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(`tab-${tabId}`).classList.add('active');
    }

    // Section group toggle
    function toggleSectionGroup(header) {
      header.closest('.section-group').classList.toggle('collapsed');
    }

    // Toast notification
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // Get/Set nested value
    function getNestedValue(obj, path) {
      return path.split('.').reduce((o, k) => (o || {})[k], obj);
    }
    function setNestedValue(obj, path, value) {
      const keys = path.split('.');
      const lastKey = keys.pop();
      const target = keys.reduce((o, k) => { if (!o[k]) o[k] = {}; return o[k]; }, obj);
      target[lastKey] = value;
    }

    function ensureArrayAtPath(obj, path) {
      const value = getNestedValue(obj, path);
      if (Array.isArray(value)) return value;
      setNestedValue(obj, path, []);
      return getNestedValue(obj, path) || [];
    }

    function findListFieldConfig(path) {
      if (!currentPage || !Array.isArray(currentPage.sections)) return null;
      for (const section of currentPage.sections) {
        if (!Array.isArray(section.fields)) continue;
        const match = section.fields.find(f => f && f.type === 'list' && f.path === path);
        if (match) return match;
      }
      return null;
    }

    function addListItem(path) {
      const arr = ensureArrayAtPath(currentData, path);
      const cfg = findListFieldConfig(path);
      const template = cfg && cfg.itemTemplate ? cfg.itemTemplate : {};
      const item = JSON.parse(JSON.stringify(template));
      arr.push(item);
      setNestedValue(currentData, path, arr);
      renderEditor(currentPage, currentData);
      markAsUnsaved();
      showToast('Neue Karte hinzugefügt (sichtbar nach Speichern).', 'success');
    }

    function deleteListItem(path, index) {
      const arr = ensureArrayAtPath(currentData, path);
      if (index < 0 || index >= arr.length) return;
      if (!confirm('Eintrag wirklich löschen?')) return;
      arr.splice(index, 1);
      setNestedValue(currentData, path, arr);
      renderEditor(currentPage, currentData);
      markAsUnsaved();
    }

    function moveListItem(path, index, direction) {
      const arr = ensureArrayAtPath(currentData, path);
      const nextIndex = index + direction;
      if (index < 0 || index >= arr.length) return;
      if (nextIndex < 0 || nextIndex >= arr.length) return;
      const tmp = arr[index];
      arr[index] = arr[nextIndex];
      arr[nextIndex] = tmp;
      setNestedValue(currentData, path, arr);
      renderEditor(currentPage, currentData);
      markAsUnsaved();
    }

    // Render editor content
    function renderEditor(config, data) {
      const container = document.getElementById('contentPane');
      let html = '';

      for (const section of config.sections) {
        html += `
          <div class="section-group" data-section-id="${section.id}">
            <div class="section-header" onclick="toggleSectionGroup(this)">
              <div class="section-header-left">
                <i class="${section.icon} icon"></i>
                <h3>${section.title}</h3>
              </div>
              <i class="fas fa-chevron-down section-toggle"></i>
            </div>
            <div class="section-body">`;

        for (const field of section.fields) {
          const value = getNestedValue(data, field.path) || '';

          if (field.type === 'textarea') {
            html += `
              <div class="form-group" data-field-path="${field.path}">
                <label class="form-label">${field.label}</label>
                <textarea class="form-textarea" data-path="${field.path}" placeholder="${field.placeholder || ''}">${value}</textarea>
              </div>`;
          } else if (field.type === 'image') {
            const prev = imageHistory[field.path] || '';
            html += `
              <div class="form-group media-field" data-field-path="${field.path}">
                <label class="form-label">${field.label}</label>
                <div class="media-row">
                  <div class="media-col">
                    <h4>Aktuelles Bild</h4>
                    <div class="media-thumb" data-media-current="${field.path}">
                      ${value ? `<img src="${value}" alt="Aktuelles Bild">` : `<span class="form-hint">Kein Bild</span>`}
                    </div>
                    <div class="media-meta" data-media-current-meta="${field.path}">${value || '—'}</div>
                  </div>
                  <div class="media-col">
                    <h4>Vorheriges Bild</h4>
                    <div class="media-thumb" data-media-previous="${field.path}">
                      ${prev ? `<img src="${prev}" alt="Vorheriges Bild">` : `<span class="form-hint">Noch kein Wechsel</span>`}
                    </div>
                    <div class="media-meta" data-media-previous-meta="${field.path}">${prev || '—'}</div>
                  </div>
                </div>
                <div class="media-actions">
                  <button class="btn btn-primary btn-sm" type="button" onclick="openMediaPickerForField('${field.path}')">
                    <i class="fas fa-image"></i> Bild auswählen
                  </button>
                  <button class="btn btn-secondary btn-sm" type="button" onclick="removeMediaForField('${field.path}')">
                    <i class="fas fa-trash"></i> Entfernen
                  </button>
                </div>
                <input type="hidden" data-path="${field.path}" value="${value}">
              </div>`;
          } else if (field.type === 'checkbox') {
            const checked = Boolean(getNestedValue(data, field.path));
            html += `
              <div class="form-group" data-field-path="${field.path}">
                <label class="form-label">${field.label}</label>
                <label class="toggle" style="display:inline-block;">
                  <input type="checkbox" data-path="${field.path}" ${checked ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
              </div>`;
          } else if (field.type === 'list') {
            const items = ensureArrayAtPath(data, field.path);
            html += `
              <div class="form-group" data-field-path="${field.path}">
                <label class="form-label">${field.label}</label>
                <p class="form-hint">Tipp: Neue/entfernte Karten sind nach Speichern sichtbar.</p>
                <div class="list-editor" data-list-path="${field.path}">
                  ${items.map((item, idx) => {
                    const labelValue = (item && field.itemLabelKey && item[field.itemLabelKey]) ? item[field.itemLabelKey] : `Eintrag ${idx + 1}`;
                    return `
                      <div class="section-group" style="margin-bottom:12px;">
                        <div class="section-header" onclick="toggleSectionGroup(this)">
                          <div class="section-header-left">
                            <i class="fas fa-grip-vertical icon"></i>
                            <h3>${labelValue}</h3>
                          </div>
                          <div style="display:flex; gap:8px; align-items:center;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); moveListItem('${field.path}', ${idx}, -1)" title="Nach oben">↑</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); moveListItem('${field.path}', ${idx}, 1)" title="Nach unten">↓</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); deleteListItem('${field.path}', ${idx})" title="Löschen">Löschen</button>
                            <i class="fas fa-chevron-down section-toggle"></i>
                          </div>
                        </div>
                        <div class="section-body">` +
                          (field.fields || []).map(sub => {
                            const subPath = `${field.path}.${idx}.${sub.key}`;
                            const subValue = getNestedValue(data, subPath) || '';

                            if (sub.type === 'image') {
                              const prev = imageHistory[subPath] || '';
                              return `
                                <div class="form-group media-field" data-field-path="${subPath}">
                                  <label class="form-label">${sub.label}</label>
                                  <div class="media-row">
                                    <div class="media-col">
                                      <h4>Aktuelles Bild</h4>
                                      <div class="media-thumb" data-media-current="${subPath}">
                                        ${subValue ? `<img src="${subValue}" alt="Aktuelles Bild">` : `<span class="form-hint">Kein Bild</span>`}
                                      </div>
                                      <div class="media-meta" data-media-current-meta="${subPath}">${subValue || '—'}</div>
                                    </div>
                                    <div class="media-col">
                                      <h4>Vorheriges Bild</h4>
                                      <div class="media-thumb" data-media-previous="${subPath}">
                                        ${prev ? `<img src="${prev}" alt="Vorheriges Bild">` : `<span class="form-hint">Noch kein Wechsel</span>`}
                                      </div>
                                      <div class="media-meta" data-media-previous-meta="${subPath}">${prev || '—'}</div>
                                    </div>
                                  </div>
                                  <div class="media-actions">
                                    <button class="btn btn-primary btn-sm" type="button" onclick="openMediaPickerForField('${subPath}')">
                                      <i class="fas fa-image"></i> Bild auswählen
                                    </button>
                                    <button class="btn btn-secondary btn-sm" type="button" onclick="removeMediaForField('${subPath}')">
                                      <i class="fas fa-trash"></i> Entfernen
                                    </button>
                                  </div>
                                  <input type="hidden" data-path="${subPath}" value="${subValue}">
                                </div>`;
                            }

                            if (sub.type === 'checkbox') {
                              const checked = Boolean(getNestedValue(data, subPath));
                              return `
                                <div class="form-group" data-field-path="${subPath}">
                                  <label class="form-label">${sub.label}</label>
                                  <label class="toggle" style="display:inline-block;">
                                    <input type="checkbox" data-path="${subPath}" ${checked ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                  </label>
                                </div>`;
                            }

                            return `
                              <div class="form-group" data-field-path="${subPath}">
                                <label class="form-label">${sub.label}</label>
                                <input type="text" class="form-input" data-path="${subPath}" value="${subValue}">
                              </div>`;
                          }).join('') +
                        `</div>
                      </div>
                    `;
                  }).join('')}
                  <button type="button" class="btn btn-primary btn-sm" onclick="addListItem('${field.path}')">
                    <i class="fas fa-plus"></i> Hinzufügen
                  </button>
                </div>
              </div>`;
          } else {
            html += `
              <div class="form-group" data-field-path="${field.path}">
                <label class="form-label">${field.label}</label>
                <input type="text" class="form-input" data-path="${field.path}" value="${value}" placeholder="${field.placeholder || ''}">
              </div>`;
          }
        }

        html += `</div></div>`;
      }

      container.innerHTML = html;
      addInputListeners();
      renderBlockList(config);
    }

    // Render block list
    function renderBlockList(config) {
      const container = document.getElementById('blockList');
      let html = '';

      for (const section of config.sections) {
        const isEnabled = section.enabled !== false;
        html += `
          <div class="block-item ${!isEnabled ? 'disabled' : ''}" data-section-id="${section.id}">
            <div class="block-icon"><i class="${section.icon}"></i></div>
            <div class="block-info">
              <div class="block-name">${section.title}</div>
              <div class="block-status">${isEnabled ? 'Sichtbar' : 'Versteckt'}</div>
            </div>
            <label class="toggle">
              <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleSection('${section.id}', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>`;
      }
      container.innerHTML = html;
    }

    // Toggle section visibility
    function toggleSection(sectionId, enabled) {
      const section = currentPage.sections.find(s => s.id === sectionId);
      if (section) section.enabled = enabled;

      const blockItem = document.querySelector(`.block-item[data-section-id="${sectionId}"]`);
      if (blockItem) {
        blockItem.classList.toggle('disabled', !enabled);
        blockItem.querySelector('.block-status').textContent = enabled ? 'Sichtbar' : 'Versteckt';
      }

      if (!currentData._sections) currentData._sections = {};
      currentData._sections[sectionId] = { enabled };

      sendMessageToIframe('toggleSection', { sectionId, enabled });
      markAsUnsaved();
    }

    // Input listeners with live update
    function addInputListeners() {
      document.querySelectorAll('.form-input, .form-textarea, input[type="checkbox"][data-path]').forEach(input => {
        const isCheckbox = input.type === 'checkbox';
        const eventName = isCheckbox ? 'change' : 'input';

        input.addEventListener(eventName, (e) => {
          const path = e.target.dataset.path;
          const value = isCheckbox ? Boolean(e.target.checked) : e.target.value;

          setNestedValue(currentData, path, value);
          sendMessageToIframe('updateContent', { path, value });
          markAsUnsaved();
        });

        input.addEventListener('focus', (e) => {
          const path = e.target.dataset.path;
          sendMessageToIframe('highlightElement', { path });

          // Highlight form group
          document.querySelectorAll('.form-group.highlight').forEach(g => g.classList.remove('highlight'));
          e.target.closest('.form-group')?.classList.add('highlight');
        });
      });
    }

    function openMediaPickerForField(path) {
      mediaPickerContext = { mode: 'data', path };
      selectedMediaUrl = null;
      loadImageGallery();
      document.getElementById('mediaModal').classList.add('visible');
    }

    function removeMediaForField(path) {
      if (!confirm('Bild wirklich entfernen?')) return;
      const previous = getNestedValue(currentData, path);
      if (previous) {
        imageHistory[path] = previous;
        if (!currentData._history) currentData._history = {};
        if (!currentData._history.images) currentData._history.images = {};
        currentData._history.images[path] = previous;
      }
      setNestedValue(currentData, path, '');
      updateMediaFieldUI(path, '', imageHistory[path] || '');
      sendMessageToIframe('updateContent', { path, value: '' });
      markAsUnsaved();
    }

    function updateSeo(key, value) {
      if (!currentData.seo) currentData.seo = {};
      currentData.seo[key] = value;

      let countId = '';
      if (key === 'meta_title') countId = 'metaTitleCount';
      if (key === 'meta_description') countId = 'metaDescCount';
      const countEl = countId ? document.getElementById(countId) : null;
      if (countEl) countEl.textContent = value.length;

      markAsUnsaved();
    }

    function closeMediaModal() {
      document.getElementById('mediaModal').classList.remove('visible');
      selectedMediaUrl = null;
    }

    async function loadImageGallery() {
      try {
        const res = await fetch(`${API_URL}/images`);
        const images = await res.json();

        const gallery = document.getElementById('imageGallery');
        gallery.innerHTML = images.map(img => `
          <div class="image-gallery-item" data-url="${img.url}" onclick="selectGalleryImage(this)">
            <img src="${encodeURI(img.url)}" alt="${img.name}">
          </div>
        `).join('');
      } catch (e) {
        console.error('Error loading images:', e);
      }
    }

    function selectGalleryImage(el) {
      document.querySelectorAll('.image-gallery-item').forEach(i => i.classList.remove('selected'));
      el.classList.add('selected');
      selectedMediaUrl = el.dataset.url;
    }

    async function handleFileUpload(input) {
      if (!input.files || !input.files[0]) return;

      const formData = new FormData();
      formData.append('file', input.files[0]);

      try {
        const res = await fetch(`${API_URL}/upload`, {
          method: 'POST',
          body: formData
        });
        const result = await res.json().catch(() => ({}));

        if (!res.ok || !result.success) {
          throw new Error(result.error || 'Upload fehlgeschlagen');
        }

        if (result.success) {
          selectedMediaUrl = result.url;
          showToast('Datei hochgeladen!', 'success');
          loadImageGallery();
        }
      } catch (e) {
        showToast('Fehler: ' + (e.message || 'Upload fehlgeschlagen'), 'error');
      } finally {
        input.value = '';
      }
    }

    function selectMedia() {
      if (!selectedMediaUrl) {
        showToast('Bitte wähle ein Bild aus', 'error');
        return;
      }

      const path = mediaPickerContext?.path;
      if (!path) {
        showToast('Kein Ziel-Feld ausgewählt.', 'error');
        return;
      }

      const previous = getNestedValue(currentData, path);
      if (previous && previous !== selectedMediaUrl) {
        imageHistory[path] = previous;
        if (!currentData._history) currentData._history = {};
        if (!currentData._history.images) currentData._history.images = {};
        currentData._history.images[path] = previous;
      }
      setNestedValue(currentData, path, selectedMediaUrl);
      updateMediaFieldUI(path, selectedMediaUrl, imageHistory[path] || '');
      sendMessageToIframe('updateContent', { path, value: selectedMediaUrl });
      markAsUnsaved();
      closeMediaModal();
    }

    function updateMediaFieldUI(path, current, previous) {
      const currentBox = document.querySelector(`[data-media-current="${path}"]`);
      const prevBox = document.querySelector(`[data-media-previous="${path}"]`);
      const currentMeta = document.querySelector(`[data-media-current-meta="${path}"]`);
      const prevMeta = document.querySelector(`[data-media-previous-meta="${path}"]`);

      if (currentBox) {
        currentBox.innerHTML = current ? `<img src="${current}" alt="Aktuelles Bild">` : `<span class="form-hint">Kein Bild</span>`;
      }
      if (prevBox) {
        prevBox.innerHTML = previous ? `<img src="${previous}" alt="Vorheriges Bild">` : `<span class="form-hint">Noch kein Wechsel</span>`;
      }
      if (currentMeta) currentMeta.textContent = current || '—';
      if (prevMeta) prevMeta.textContent = previous || '—';
    }

    // Unsaved changes
    function markAsUnsaved() {
      hasUnsavedChanges = true;
      document.getElementById('statusBadge').className = 'status-badge unsaved';
      document.getElementById('statusText').textContent = 'Ungespeichert';
    }

    function markAsSaved() {
      hasUnsavedChanges = false;
      document.getElementById('statusBadge').className = 'status-badge draft';
      document.getElementById('statusText').textContent = 'Gespeichert';
    }

    // Save data
    async function saveData(publish = false) {
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Speichere...';

      try {
        // Save page data
        const res = await fetch(`${API_URL}/data/${currentPage.dataFile}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(currentData)
        });

        if (!res.ok) throw new Error('Speichern fehlgeschlagen');

        markAsSaved();
        document.getElementById('lastSavedText').textContent = `Gespeichert um ${new Date().toLocaleTimeString('de-DE')}`;

        let buildOk = true;
        document.getElementById('statusText').textContent = 'Baue...';

        try {
          const buildRes = await fetch(`${API_URL}/build`, { method: 'POST' });
          const buildJson = await buildRes.json().catch(() => ({}));
          buildOk = buildRes.ok && (buildJson.success !== false);
        } catch {
          buildOk = false;
        }

        if (publish && buildOk) {
          document.getElementById('statusBadge').className = 'status-badge published';
          document.getElementById('statusText').textContent = 'Veröffentlicht';
          showToast('Erfolgreich veröffentlicht!', 'success');
        } else if (publish && !buildOk) {
          document.getElementById('statusBadge').className = 'status-badge draft';
          document.getElementById('statusText').textContent = 'Gespeichert';
          showToast('Gespeichert, aber Build fehlgeschlagen.', 'error');
        } else if (!publish && buildOk) {
          document.getElementById('statusBadge').className = 'status-badge draft';
          document.getElementById('statusText').textContent = 'Gespeichert';
          showToast('Änderungen gespeichert!', 'success');
        } else {
          document.getElementById('statusBadge').className = 'status-badge draft';
          document.getElementById('statusText').textContent = 'Gespeichert';
          showToast('Gespeichert, aber Build fehlgeschlagen.', 'error');
        }

        if (buildOk) {
          refreshPreview();
        }

      } catch (err) {
        showToast('Fehler: ' + err.message, 'error');
      }

      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="fas fa-save"></i> Speichern';
    }

    function confirmPublish() {
      document.getElementById('publishModal').classList.add('visible');
    }
    function closePublishModal() {
      document.getElementById('publishModal').classList.remove('visible');
    }
    function publishChanges() {
      closePublishModal();
      saveData(true);
    }

    // Load page data
    async function loadPageData() {
      currentPage = pageConfigs[pageSlug];
      if (!currentPage) {
        document.getElementById('contentPane').innerHTML = '<p class="empty-state">Seite nicht gefunden.</p>';
        return;
      }

      document.getElementById('pageTitle').textContent = currentPage.title + ' bearbeiten';
      document.getElementById('editorTitle').textContent = currentPage.title;
      document.getElementById('previewUrl').textContent = window.location.host + currentPage.previewUrl;
      loadPreview();

      try {
        const res = await fetch(`${API_URL}/data/${currentPage.dataFile}`);
        if (res.ok) {
          currentData = await res.json();
          if (currentData._history && currentData._history.images) {
            Object.assign(imageHistory, currentData._history.images);
          }
          if (currentData._sections && Array.isArray(currentPage.sections)) {
            currentPage.sections.forEach(section => {
              const stored = currentData._sections[section.id];
              if (stored && typeof stored.enabled === 'boolean') {
                section.enabled = stored.enabled;
              }
            });
          }
        }
        renderEditor(currentPage, currentData);

        // SEO (optional)
        const seoTabBtn = document.querySelector('.editor-tab[data-tab="seo"]');
        const showSeo = currentPage.dataFile !== 'global.json';
        if (seoTabBtn) seoTabBtn.style.display = showSeo ? '' : 'none';
        if (!showSeo && document.querySelector('.editor-tab.active')?.dataset.tab === 'seo') {
          switchTab('content');
        }

        const seo = currentData.seo || {};
        const titleVal = seo.meta_title || '';
        const descVal = seo.meta_description || '';
        document.getElementById('metaTitle').value = titleVal;
        document.getElementById('metaDesc').value = descVal;
        document.getElementById('metaTitleCount').textContent = String(titleVal.length);
        document.getElementById('metaDescCount').textContent = String(descVal.length);
      } catch (err) {
        currentData = {};
        renderEditor(currentPage, currentData);

        const seoTabBtn = document.querySelector('.editor-tab[data-tab="seo"]');
        const showSeo = currentPage.dataFile !== 'global.json';
        if (seoTabBtn) seoTabBtn.style.display = showSeo ? '' : 'none';
        document.getElementById('metaTitle').value = '';
        document.getElementById('metaDesc').value = '';
        document.getElementById('metaTitleCount').textContent = '0';
        document.getElementById('metaDescCount').textContent = '0';
      }
    }

    function loadPreview() {
      iframeReady = false;
      document.getElementById('previewIframe').src = `${PREVIEW_URL}${currentPage.previewUrl}?_t=${Date.now()}`;
    }

    function refreshPreview() {
      loadPreview();
      showToast('Vorschau aktualisiert', 'success');
    }

    function openInNewWindow() {
      window.open(PREVIEW_URL + currentPage.previewUrl, '_blank');
    }

    // Viewport switcher
    document.querySelectorAll('.viewport-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.viewport-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('previewFrame').className = 'preview-iframe-wrapper ' + btn.dataset.viewport;
      });
    });

    // Message handling
    window.addEventListener('message', (event) => {
      if (event.origin !== PREVIEW_URL) return;
      const { type, payload } = event.data || {};

      if (type === 'elementClicked') {
        focusEditorField(payload.path);
      } else if (type === 'iframeReady') {
        iframeReady = true;
        pendingUpdates.forEach(msg => sendMessageToIframe(msg.type, msg.payload));
        pendingUpdates = [];
        sendMessageToIframe('setEditMode', { enabled: true });
        sendMessageToIframe('initialLoad', currentData);
        if (currentData && currentData._sections) {
          Object.entries(currentData._sections).forEach(([sectionId, state]) => {
            if (state && typeof state.enabled === 'boolean') {
              sendMessageToIframe('toggleSection', { sectionId, enabled: state.enabled });
            }
          });
        }
      }
    });

    function focusEditorField(path) {
      switchTab('content');
      const field = document.querySelector(`[data-path="${path}"]`);
      if (field) {
        document.querySelectorAll('.form-group.highlight').forEach(g => g.classList.remove('highlight'));
        field.closest('.form-group')?.classList.add('highlight');

        // Expand section if collapsed
        const sectionGroup = field.closest('.section-group');
        if (sectionGroup?.classList.contains('collapsed')) {
          sectionGroup.classList.remove('collapsed');
        }

        field.focus();
        field.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function sendMessageToIframe(type, payload) {
      const iframe = document.getElementById('previewIframe');
      if (iframe?.contentWindow) {
        if (!iframeReady) {
          pendingUpdates.push({ type, payload });
          return;
        }
        iframe.contentWindow.postMessage({ type, payload }, PREVIEW_URL);
      }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closePublishModal();
        closeMediaModal();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveData(false);
      }
    });

    // Warn before leaving
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Click outside modal to close
    document.getElementById('publishModal').addEventListener('click', (e) => {
      if (e.target.id === 'publishModal') closePublishModal();
    });
    document.getElementById('mediaModal').addEventListener('click', (e) => {
      if (e.target.id === 'mediaModal') closeMediaModal();
    });

    // Init
    loadPageData();
  </script>
</body>
</html>
